<!-- Creator     : groff version 1.18.1.4 -->
<!-- CreationDate: Sat Nov 12 06:31:51 2016 -->
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta name="Content-Style" content="text/css">
<title></title>
</head>
<body>

<hr>

<p>RPC.STATD(8) RPC.STATD(8)</p>

<p>NAME rpc.statd - NSM service daemon</p>

<p>SYNOPSIS rpc.statd [-dh?FLNvVw] [-H prog] [-n my-name]
[-o outgoing-port] [-p listener-port] [-P path ]</p>

<p>DESCRIPTION File locks are not part of persistent file
system state. Lock state is thus lost when a host
reboots.</p>

<p>Network file systems must also detect when lock state is
lost because a remote host has rebooted. After an NFS client
reboots, an NFS server must release all file locks held by
applications that were running on that client. After a
server reboots, a client must remind the server of file
locks held by applications running on that client.</p>

<p>For NFS version 2 [RFC1094] and NFS version 3 [RFC1813],
the Network Status Monitor protocol (or NSM for short) is
used to notify NFS peers of reboots. On Linux, two separate
user-space components constitute the NSM service:</p>

<p>rpc.statd A daemon that listens for reboot notifications
from other hosts, and manages the list of hosts to be
notified when the local sys- tem reboots</p>

<p>sm-notify A helper program that notifies NFS peers after
the local system reboots</p>

<p>The local NFS lock manager alerts its local rpc.statd of
each remote peer that should be monitored. When the local
system reboots, the sm- notify command notifies the NSM
service on monitored peers of the reboot. When a remote
reboots, that peer notifies the local rpc.statd, which in
turn passes the reboot notification back to the local NFS
lock manager.</p>

<p>NSM OPERATION IN DETAIL The first file locking
interaction between an NFS client and server causes the NFS
lock managers on both peers to contact their local NSM
service to store information about the opposite peer. On
Linux, the local lock manager contacts rpc.statd.</p>

<p>rpc.statd records information about each monitored NFS
peer on persis- tent storage. This information describes how
to contact a remote peer in case the local system reboots,
how to recognize which monitored peer is reporting a reboot,
and how to notify the local lock manager when a monitored
peer indicates it has rebooted.</p>

<p>An NFS client sends a hostname, known as the clients
caller_name, in each file lock request. An NFS server can
use this hostname to send asynchronous GRANT calls to a
client, or to notify the client it has rebooted.</p>

<p>The Linux NFS server can provide the client s
caller_name or the client s network address to rpc.statd.
For the purposes of the NSM protocol, this name or address
is known as the monitored peers mon_name. In addition, the
local lock manager tells rpc.statd what it thinks its own
hostname is. For the purposes of the NSM protocol, this
hostname is known as my_name.</p>

<p>There is no equivalent interaction between an NFS server
and a client to inform the client of the server s
caller_name. Therefore NFS clients do not actually know what
mon_name an NFS server might use in an SM_NOTIFY request.
The Linux NFS client uses the server hostname from the mount
command to identify rebooting NFS servers.</p>

<p>Reboot notification When the local system reboots, the
sm-notify command reads the list of monitored peers from
persistent storage and sends an SM_NOTIFY request to the NSM
service on each listed remote peer. It uses the mon_name
string as the destination. To identify which host has
rebooted, the sm-notify command sends the my_name string
recorded when that remote was monitored. The remote
rpc.statd matches incoming SM_NOTIFY requests using this
string, or the caller s network address, to one or more
peers on its own monitor list.</p>

<p>If rpc.statd does not find a peer on its monitor list
that matches an incoming SM_NOTIFY request, the notification
is not forwarded to the local lock manager. In addition,
each peer has its own NSM state num- ber, a 32-bit integer
that is bumped after each reboot by the sm-notify command.
rpc.statd uses this number to distinguish between actual
reboots and replayed notifications.</p>

<p>Part of NFS lock recovery is rediscovering which peers
need to be moni- tored again. The sm-notify command clears
the monitor list on persis- tent storage after each
reboot.</p>

<p>OPTIONS -d, --no-syslog Causes rpc.statd to write log
messages on stderr instead of to the system log, if the -F
option was also specified.</p>

<p>-F, --foreground Keeps rpc.statd attached to its
controlling terminal so that NSM operation can be monitored
directly or run under a debugger. If this option is not
specified, rpc.statd backgrounds itself soon after it
starts.</p>

<p>-h, -?, --help Causes rpc.statd to display usage
information on stderr and then exit.</p>

<p>-H, --ha-callout prog Specifies a high availability
callout program. If this option is not specified, no
callouts are performed. See the High- availability callouts
section below for details.</p>

<p>-L, --no-notify Prevents rpc.statd from running the
sm-notify command when it starts up, preserving the existing
NSM state number and monitor list.</p>

<p>Note: the sm-notify command contains a check to ensure
it runs only once after each system reboot. This prevents
spurious reboot notification if rpc.statd restarts without
the -L option.</p>

<p>-n, --name ipaddr | hostname Specifies the bind address
used for RPC listener sockets. The ipaddr form can be
expressed as either an IPv4 or an IPv6 pre- sentation
address. If this option is not specified, rpc.statd uses a
wildcard address as the transport bind address.</p>

<p>This string is also passed to the sm-notify command to
be used as the source address from which to send reboot
notification requests. See sm-notify(8) for details.</p>

<p>-N Causes rpc.statd to run the sm-notify command, and
then exit. Since the sm-notify command can also be run
directly, this option is deprecated.</p>

<p>-o, --outgoing-port port Specifies the source port
number the sm-notify command should use when sending reboot
notifications. See sm-notify(8) for details.</p>

<p>-p, --port port Specifies the port number used for RPC
listener sockets. If this option is not specified, rpc.statd
chooses a random ephemeral port for each listener
socket.</p>

<p>This option can be used to fix the port value of its
listeners when SM_NOTIFY requests must traverse a firewall
between clients and servers.</p>

<p>-P, --state-directory-path pathname Specifies the
pathname of the parent directory where NSM state information
resides. If this option is not specified, rpc.statd uses
/var/lib/nfs/statd by default.</p>

<p>After starting, rpc.statd attempts to set its effective
UID and GID to the owner and group of this directory.</p>

<p>-v, -V, --version Causes rpc.statd to display version
information on stderr and then exit.</p>

<p>SECURITY The rpc.statd daemon must be started as root to
acquire privileges needed to create sockets with privileged
source ports, and to access the state information database.
Because rpc.statd maintains a long- running network service,
however, it drops root privileges as soon as it starts up to
reduce the risk of a privilege escalation attack.</p>

<p>During normal operation, the effective user ID it
chooses is the owner of the state directory. This allows it
to continue to access files in that directory after it has
dropped its root privileges. To control which user ID
rpc.statd chooses, simply use chown(1) to set the owner of
the state directory.</p>

<p>You can also protect your rpc.statd listeners using the
tcp_wrapper library or iptables(8). To use the tcp_wrapper
library, add the host- names of peers that should be allowed
access to /etc/hosts.allow. Use the daemon name statd even
if the rpc.statd binary has a different filename.</p>

<p>For further information see the tcpd(8) and
hosts_access(5) man pages.</p>

<p>ADDITIONAL NOTES Lock recovery after a reboot is
critical to maintaining data integrity and preventing
unnecessary application hangs. To help rpc.statd match
SM_NOTIFY requests to NLM requests, a number of best
practices should be observed, including:</p>

<p>The UTS nodename of your systems should match the DNS
names that NFS peers use to contact them</p>

<p>The UTS nodenames of your systems should always be fully
quali- fied domain names</p>

<p>The forward and reverse DNS mapping of the UTS nodenames
should be consistent</p>

<p>The hostname the client uses to mount the server should
match the servers mon_name in SM_NOTIFY requests it
sends</p>

<p>Unmounting an NFS file system does not necessarily stop
either the NFS client or server from monitoring each other.
Both may continue moni- toring each other for a time in case
subsequent NFS traffic between the two results in fresh
mounts and additional file locking.</p>

<p>On Linux, if the lockd kernel module is unloaded during
normal opera- tion, all remote NFS peers are unmonitored.
This can happen on an NFS client, for example, if an
automounter removes all NFS mount points due to
inactivity.</p>

<p>High-availability callouts rpc.statd can exec a special
callout program during processing of suc- cessful SM_MON,
SM_UNMON, and SM_UNMON_ALL requests. Such a program may be
used in High Availability NFS (HA-NFS) environments to track
lock state that may need to be migrated after a system
reboot.</p>

<p>The name of the callout program is specified with the -H
option. The program is run with 3 arguments: The first is
either add-client or del- client depending on the reason for
the callout. The second is the mon_name of the monitored
peer. The third is the caller_name of the requesting lock
manager.</p>

<p>IPv6 and TI-RPC support TI-RPC is a pre-requisite for
supporting NFS on IPv6. If TI-RPC sup- port is built into
rpc.statd, it attempts to start listeners on network
transports marked /etc/netconfig. As long as at least one
network transport listener starts successfully, rpc.statd
will operate.</p>

<p>FILES /var/lib/nfs/statd/sm directory containing monitor
list</p>

<p>/var/lib/nfs/statd/sm.bak directory containing notify
list</p>

<p>/var/lib/nfs/statd/state NSM state number for this
host</p>

<p>/var/run/run.statd.pid pid file</p>

<p>/etc/netconfig network transport capability database</p>

<p>SEE ALSO sm-notify(8), nfs(5), rpc.nfsd(8), rpcbind(8),
tcpd(8), hosts_access(5), iptables(8), netconfig(5)</p>

<p>RFC 1094 - &quot;NFS: Network File System Protocol
Specification&quot; RFC 1813 - &quot;NFS Version 3 Protocol
Specification&quot; OpenGroup Protocols for Interworking:
XNFS, Version 3W - Chapter 11</p>

<p>AUTHORS Jeff Uphoff
&lt;juphoff@users.sourceforge.net&gt; Olaf Kirch
&lt;okir@monad.swb.de&gt; H.J. Lu &lt;hjl@gnu.org&gt; Lon
Hohberger &lt;hohberger@missioncriticallinux.com&gt; Paul
Clements &lt;paul.clements@steeleye.com&gt; Chuck Lever
&lt;chuck.lever@oracle.com&gt;</p>

<p>1 November 2009 RPC.STATD(8)</p>
<hr>
</body>
</html>
