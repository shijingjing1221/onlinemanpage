<!-- Creator     : groff version 1.18.1.4 -->
<!-- CreationDate: Sat Nov 12 06:44:15 2016 -->
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta name="Content-Style" content="text/css">
<title></title>
</head>
<body>

<hr>

<p>virt-win-reg(1) Virtualization Support
virt-win-reg(1)</p>

<p>NAME virt-win-reg - Export and merge Windows Registry
entries from a Windows guest</p>

<p>SYNOPSIS virt-win-reg domname
&rsquo;HKLMPathTokey&rsquo;</p>

<p>virt-win-reg domname &rsquo;HKLMPathTokey&rsquo;
name</p>

<p>virt-win-reg domname &rsquo;HKLMPathTokey&rsquo; @</p>

<p>virt-win-reg --merge domname [input.reg ...]</p>

<p>virt-win-reg [--options] disk.img ... # instead of
domname</p>

<p>WARNING You must not use &quot;virt-win-reg&quot; with
the --merge option on live virtual machines. If you do this,
you will get irreversible disk corruption in the VM.
&quot;virt-win-reg&quot; tries to stop you from doing this,
but doesnt catch all cases.</p>

<p>Modifying the Windows Registry is an inherently risky
operation. The format is deliberately obscure and
undocumented, and Registry changes can leave the system
unbootable. Therefore when using the --merge option, make
sure you have a reliable backup first.</p>

<p>DESCRIPTION This program can export and merge Windows
Registry entries from a Windows guest.</p>

<p>The first parameter is the libvirt guest name or the raw
disk image of a Windows guest.</p>

<p>If --merge is not specified, then the chosen registry
key is displayed/exported (recursively). For example:</p>

<p>$ virt-win-reg Windows7
&rsquo;HKEY_LOCAL_MACHINETWAREcrosoft&rsquo;</p>

<p>You can also display single values from within registry
keys, for example:</p>

<p>$ cvkey=&rsquo;HKLMTWAREcrosoftWindows NT $ virt-win-reg
Windows7 $cvkey ProductName Windows 7 Enterprise</p>

<p>With --merge, you can merge a textual regedit file into
the Windows Registry:</p>

<p>$ virt-win-reg --merge Windows7 changes.reg</p>

<p>NOTE This program is only meant for simple access to the
registry. If you want to do complicated things with the
registry, we suggest you download the Registry hive files
from the guest using libguestfs(3) or guestfish(1) and
access them locally, eg. using hivex(3), hivexsh(1) or
hivexregedit(1).</p>

<p>OPTIONS --help Display brief help.</p>

<p>--version Display version number and exit.</p>

<p>--debug Enable debugging messages.</p>

<p>-c URI --connect URI If using libvirt, connect to the
given URI. If omitted, then we connect to the default
libvirt hypervisor.</p>

<p>If you specify guest block devices directly, then
libvirt is not used at all.</p>

<p>--format raw Specify the format of disk images given on
the command line. If this is omitted then the format is
autodetected from the content of the disk image.</p>

<p>If disk images are requested from libvirt, then this
program asks libvirt for this information. In this case, the
value of the format parameter is ignored.</p>

<p>If working with untrusted raw-format guest disk images,
you should ensure the format is always specified.</p>

<p>--merge In merge mode, this merges a textual regedit
file into the Windows Registry of the virtual machine. If
this flag is not given then virt-win-reg displays or exports
Registry entries instead.</p>

<p>Note that --merge is unsafe to use on live virtual
machines, and will result in disk corruption. However
exporting (without this flag) is always safe.</p>

<p>--encoding UTF-16LE|ASCII When merging (only), you may
need to specify the encoding for strings to be used in the
hive file. This is explained in detail in &quot;ENCODING
STRINGS&quot; in Win::Hivex::Regedit(3).</p>

<p>The default is to use UTF-16LE, which should work with
recent versions of Windows.</p>

<p>--unsafe-printable-strings When exporting (only), assume
strings are UTF-16LE and print them as strings instead of
hex sequences. Remove the final zero codepoint from strings
if present.</p>

<p>This is unsafe and does not preserve the fidelity of
strings in the original Registry for various reasons:</p>

<p>&middot; Assumes the original encoding is UTF-16LE.
ASCII strings and strings in other encodings will be
corrupted by this transformation.</p>

<p>&middot; Assumes that everything which has type 1 or 2
is really a string and that everything else is not a string,
but the type field in real Registries is not reliable.</p>

<p>&middot; Loses information about whether a zero
codepoint followed the string in the Registry or not.</p>

<p>This all happens because the Registry itself contains no
information about how strings are encoded (see
&quot;ENCODING STRINGS&quot; in Win::Hivex::Regedit(3)).</p>

<p>You should only use this option for quick hacking and
debugging of the Registry contents, and never use it if the
output is going to be passed into another program or stored
in another Registry.</p>

<p>SUPPORTED SYSTEMS The program currently supports Windows
NT-derived guests starting with Windows XP through to at
least Windows 8.</p>

<p>The following Registry keys are supported:</p>

<p>&quot;HKEY_LOCAL_MACHINE&quot;
&quot;HKEY_LOCAL_MACHINEURITY&quot;
&quot;HKEY_LOCAL_MACHINETWARE&quot;
&quot;HKEY_LOCAL_MACHINETEM&quot;
&quot;HKEY_USERS.DEFAULT&quot; &quot;HKEY_USERS&quot; where
SID is a Windows User SID (eg. &quot;S-1-5-18&quot;).</p>

<p>&quot;HKEY_USERSsername&quot; where username is a local
user name (this is a libguestfs extension).</p>

<p>You can use &quot;HKLM&quot; as a shorthand for
&quot;HKEY_LOCAL_MACHINE&quot;, and &quot;HKU&quot; for
&quot;HKEY_USERS&quot;.</p>

<p>The literal keys &quot;HKEY_USERSID&quot; and
&quot;HKEY_CURRENT_USER&quot; are not supported (there is no
&quot;current user&quot;).</p>

<p>WINDOWS 8 Windows 8 &quot;fast startup&quot; can prevent
virt-win-reg from being able to edit the Registry. See
&quot;WINDOWS HIBERNATION AND WINDOWS 8 FAST STARTUP&quot;
in guestfs(3).</p>

<p>ENCODING &quot;virt-win-reg&quot; expects that regedit
files have already been reencoded in the local encoding.
Usually on Linux hosts, this means UTF-8 with Unix-style
line endings. Since Windows regedit files are often in
UTF-16LE with Windows-style line endings, you may need to
reencode the whole file before or after processing.</p>

<p>To reencode a file from Windows format to Linux (before
processing it with the --merge option), you would do
something like this:</p>

<p>iconv -f utf-16le -t utf-8 &lt; win.reg | dos2unix &gt;
linux.reg</p>

<p>To go in the opposite direction, after exporting and
before sending the file to a Windows user, do something like
this:</p>

<p>unix2dos linux.reg | iconv -f utf-8 -t utf-16le &gt;
win.reg</p>

<p>For more information about encoding, see
Win::Hivex::Regedit(3).</p>

<p>If you are unsure about the current encoding, use the
file(1) command. Recent versions of Windows regedit.exe
produce a UTF-16LE file with Windows-style (CRLF) line
endings, like this:</p>

<p>$ file software.reg software.reg: Little-endian UTF-16
Unicode text, with very long lines, with CRLF line
terminators</p>

<p>This file would need conversion before you could --merge
it.</p>

<p>CurrentControlSet etc. Registry keys like
&quot;CurrentControlSet&quot; dont really exist in the
Windows Registry at the level of the hive file, and
therefore you cannot modify these.</p>

<p>&quot;CurrentControlSet&quot; is usually an alias for
&quot;ControlSet001&quot;. In some circumstances it might
refer to another control set. The way to find out is to look
at the &quot;HKLMTEMect&quot; key:</p>

<p># virt-win-reg WindowsGuest &rsquo;HKLMTEMect&rsquo;
[HKEY_LOCAL_MACHINETEMect]
&quot;Current&quot;=dword:00000001
&quot;Default&quot;=dword:00000001
&quot;Failed&quot;=dword:00000000
&quot;LastKnownGood&quot;=dword:00000002</p>

<p>&quot;Current&quot; is the one which Windows will choose
when it boots.</p>

<p>Similarly, other &quot;Current...&quot; keys in the path
may need to be replaced.</p>

<p>DELETING REGISTRY KEYS AND VALUES To delete a whole
registry key, use the syntax:</p>

<p>[-HKEY_LOCAL_MACHINEo]</p>

<p>To delete a single value within a key, use the
syntax:</p>

<p>[HKEY_LOCAL_MACHINEo] &quot;Value&quot;=-</p>

<p>WINDOWS TIPS Note that some of these tips modify the
guest disk image. The guest must be shut off, else you will
get disk corruption.</p>

<p>RUNNING A BATCH SCRIPT WHEN A USER LOGS IN Prepare a DOS
batch script, VBScript or executable. Upload this using
guestfish(1). For this example the script is called
&quot;test.bat&quot; and it is uploaded into &quot;C:</p>

<p>guestfish -i -d WindowsGuest upload test.bat
/test.bat</p>

<p>Prepare a regedit file containing the registry
change:</p>

<p>cat &gt; test.reg &lt;&lt;&rsquo;EOF&rsquo;
[HKLMtwarecrosoftWindows
&quot;Test&quot;=&quot;c:\test.bat&quot; EOF</p>

<p>In this example we use the key &quot;RunOnce&quot; which
means that the script will run precisely once when the first
user logs in. If you want it to run every time a user logs
in, replace &quot;RunOnce&quot; with &quot;Run&quot;.</p>

<p>Now update the registry:</p>

<p>virt-win-reg --merge WindowsGuest test.reg</p>

<p>INSTALLING A SERVICE This section assumes you are
familiar with Windows services, and you either have a
program which handles the Windows Service Control Protocol
directly or you want to run any program using a service
wrapper like SrvAny or the free RHSrvAny.</p>

<p>First upload the program and optionally the service
wrapper. In this case the test program is called
&quot;test.exe&quot; and we are using the RHSrvAny
wrapper:</p>

<p>guestfish -i -d WindowsGuest &lt;&lt;EOF upload
rhsrvany.exe /rhsrvany.exe upload test.exe /test.exe EOF</p>

<p>Prepare a regedit file containing the registry changes.
In this example, the first registry change is needed for the
service itself or the service wrapper (if used). The second
registry change is only needed because I am using the
RHSrvAny service wrapper.</p>

<p>cat &gt; service.reg &lt;&lt;&rsquo;EOF&rsquo;
[HKLMTEMlSet001vices &quot;Type&quot;=dword:00000010
&quot;Start&quot;=dword:00000002
&quot;ErrorControl&quot;=dword:00000001
&quot;ImagePath&quot;=&quot;c:\rhsrvany.exe&quot;
&quot;DisplayName&quot;=&quot;RHSrvAny&quot;
&quot;ObjectName&quot;=&quot;NetworkService&quot;</p>

<p>[HKLMTEMlSet001vices
&quot;CommandLine&quot;=&quot;c:\test.exe&quot;
&quot;PWD&quot;=&quot;c:\Temp&quot; EOF</p>

<p>Notes:</p>

<p>&middot; For use of &quot;ControlSet001&quot; see the
section above in this manual page. You may need to adjust
this according to the control set that is in use by the
guest.</p>

<p>&middot; &quot;ObjectName&quot; controls the privileges
that the service will have. An alternative is
&quot;ObjectName&quot;=&quot;LocalSystem&quot; which would
be the most privileged account.</p>

<p>&middot; For the meaning of the magic numbers, see this
Microsoft KB article:
http://support.microsoft.com/kb/103000.</p>

<p>Update the registry:</p>

<p>virt-win-reg --merge WindowsGuest service.reg</p>

<p>SHELL QUOTING Be careful when passing parameters
containing &quot; shell. Usually you will have to use single
quotes or double backslashes (but not both) to protect them
from the shell.</p>

<p>Paths and value names are case-insensitive.</p>

<p>Libvirt guest names can contain arbitrary characters,
some of which have meaning to the shell such as
&quot;#&quot; and space. You may need to quote or escape
these characters on the command line. See the shell manual
page sh(1) for details.</p>

<p>SEE ALSO hivex(3), hivexsh(1), hivexregedit(1),
guestfs(3), guestfish(1), virt-cat(1), Sys::Guestfs(3),
Sys::Guestfs::Lib(3), Win::Hivex(3), Win::Hivex::Regedit(3),
Sys::Virt(3), http://libguestfs.org/.</p>

<p>AUTHOR Richard W.M. Jones
http://people.redhat.com/~rjones/</p>

<p>COPYRIGHT Copyright (C) 2010 Red Hat Inc.</p>

<p>LICENSE This program is free software; you can
redistribute it and/or modify it under the terms of the GNU
General Public License as published by the Free Software
Foundation; either version 2 of the License, or (at your
option) any later version.</p>

<p>This program is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY; without even the implied
warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE. See the GNU General Public License for more
details.</p>

<p>You should have received a copy of the GNU General
Public License along with this program; if not, write to the
Free Software Foundation, Inc., 51 Franklin Street, Fifth
Floor, Boston, MA 02110-1301 USA.</p>

<p>BUGS To get a list of bugs against libguestfs, use this
link:
https://bugzilla.redhat.com/buglist.cgi?component=libguestfs&amp;product=Virtualization+Tools</p>

<p>To report a new bug against libguestfs, use this link:
https://bugzilla.redhat.com/enter_bug.cgi?component=libguestfs&amp;product=Virtualization+Tools</p>

<p>When reporting a bug, please supply:</p>

<p>&middot; The version of libguestfs.</p>

<p>&middot; Where you got libguestfs (eg. which Linux
distro, compiled from source, etc)</p>

<p>&middot; Describe the bug accurately and give a way to
reproduce it.</p>

<p>&middot; Run libguestfs-test-tool(1) and paste the
complete, unedited output into the bug report.</p>

<p>libguestfs-1.20.11 2013-08-27 virt-win-reg(1)</p>
<hr>
</body>
</html>
