<!-- Creator     : groff version 1.18.1.4 -->
<!-- CreationDate: Sat Nov 12 06:43:55 2016 -->
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta name="Content-Style" content="text/css">
<title></title>
</head>
<body>

<hr>

<p>virt-sparsify(1) Virtualization Support
virt-sparsify(1)</p>

<p>NAME virt-sparsify - Make a virtual machine disk
sparse</p>

<p>SYNOPSIS virt-sparsify [--options] indisk outdisk</p>

<p>DESCRIPTION Virt-sparsify is a tool which can make a
virtual machine disk (or any disk image) sparse a.k.a.
thin-provisioned. This means that free space within the disk
image can be converted back to free space on the host.</p>

<p>Virt-sparsify can locate and sparsify free space in most
filesystems (eg. ext2/3/4, btrfs, NTFS, etc.), and also in
LVM physical volumes.</p>

<p>Virt-sparsify can also convert between some disk
formats, for example converting a raw disk image to a
thin-provisioned qcow2 image.</p>

<p>Virt-sparsify can operate on any disk image, not just
ones from virtual machines. However if a virtual machine has
multiple disks and uses volume management, then
virt-sparsify will work but not be very effective
(http://bugzilla.redhat.com/887826).</p>

<p>IMPORTANT NOTE ABOUT SPARSE OUTPUT IMAGES If the input
is raw, then the default output is raw sparse. You must
check the output size using a tool that understands
sparseness such as &quot;du -sh&quot;. It can make a huge
difference:</p>

<p>$ ls -lh test1.img -rw-rw-r--. 1 rjones rjones 100M Aug
8 08:08 test1.img $ du -sh test1.img 3.6M test1.img</p>

<p>(Compare the apparent size 100M vs the actual size
3.6M)</p>

<p>IMPORTANT LIMITATIONS &middot; Virt-sparsify does not do
in-place modifications. It copies from a source image to a
destination image, leaving the source unchanged. Check that
the sparsification was successful before deleting the source
image.</p>

<p>&middot; The virtual machine must be shut down before
using this tool.</p>

<p>&middot; Virt-sparsify may require up to 2x the virtual
size of the source disk image (1 temporary copy + 1
destination image). This is in the worst case and usually
much less space is required.</p>

<p>&middot; Virt-sparsify cannot resize disk images. To do
that, use virt-resize(1).</p>

<p>&middot; Virt-sparsify cannot handle encrypted disks.
Libguestfs supports encrypted disks, but encrypted disks
themselves cannot be sparsified.</p>

<p>&middot; Virt-sparsify cannot yet sparsify the space
between partitions. Note that this space is often used for
critical items like bootloaders so its not really
unused.</p>

<p>You may also want to read the manual pages for the
associated tools virt-filesystems(1) and virt-df(1) before
starting.</p>

<p>EXAMPLES Typical usage is:</p>

<p>virt-sparsify indisk outdisk</p>

<p>which copies &quot;indisk&quot; to &quot;outdisk&quot;,
making the output sparse. &quot;outdisk&quot; is created, or
overwritten if it already exists. The format of the input
disk is detected (eg. qcow2) and the same format is used for
the output disk.</p>

<p>To convert between formats, use the --convert
option:</p>

<p>virt-sparsify disk.raw --convert qcow2 disk.qcow2</p>

<p>Virt-sparsify tries to zero and sparsify free space on
every filesystem it can find within the source disk image.
You can get it to ignore (dont zero free space on) certain
filesystems by doing:</p>

<p>virt-sparsify --ignore /dev/sda1 indisk outdisk</p>

<p>See virt-filesystems(1) to get a list of filesystems
within a disk image.</p>

<p>OPTIONS --help Display help.</p>

<p>--check-tmpdir=ignore --check-tmpdir=continue
--check-tmpdir=warn --check-tmpdir=fail Check if
&quot;TMPDIR&quot; or --tmp directory has enough space to
complete the operation. This is just an estimate.</p>

<p>If the check indicates a problem, then you can
either:</p>

<p>&middot; ignore it,</p>

<p>&middot; print a warning and continue,</p>

<p>&middot; warn and wait for the user to press the Return
key (this is the default), or:</p>

<p>&middot; fail and exit.</p>

<p>--compress Compress the output file. This only works if
the output format is &quot;qcow2&quot;.</p>

<p>--convert raw --convert qcow2 --convert [other formats]
Use &quot;output-format&quot; as the format for the
destination image. If this is not specified, then the input
format is used.</p>

<p>Supported and known-working output formats are:
&quot;raw&quot;, &quot;qcow2&quot;, &quot;vdi&quot;.</p>

<p>You can also use any format supported by the qemu-img(1)
program, eg. &quot;vmdk&quot;, but support for other formats
is reliant on qemu.</p>

<p>Specifying the --convert option is usually a good idea,
because then virt-sparsify doesn t need to try to guess the
input format.</p>

<p>For fine-tuning the output format, see: --compress,
-o.</p>

<p>--debug-gc Debug garbage collection and memory
allocation. This is only useful when debugging memory
problems in virt-sparsify or the OCaml libguestfs
bindings.</p>

<p>--format raw --format qcow2 Specify the format of the
input disk image. If this flag is not given then it is
auto-detected from the image itself.</p>

<p>If working with untrusted raw-format guest disk images,
you should ensure the format is always specified.</p>

<p>--ignore filesystem --ignore volgroup Ignore the named
filesystem. Free space on the filesystem will not be zeroed,
but existing blocks of zeroes will still be sparsified.</p>

<p>In the second form, this ignores the named volume group.
Use the volume group name without the &quot;/dev/&quot;
prefix, eg. --ignore vg_foo</p>

<p>You can give this option multiple times.</p>

<p>--machine-readable This option is used to make the
output more machine friendly when being parsed by other
programs. See &quot;MACHINE READABLE OUTPUT&quot; below.</p>

<p>-o option[,option,...] Pass -o option(s) to the
qemu-img(1) command to fine-tune the output format. Options
available depend on the output format (see --convert) and
the installed version of the qemu-img program.</p>

<p>You should use -o at most once. To pass multiple
options, separate them with commas, eg:</p>

<p>virt-sparsify --convert qcow2 -o
cluster_size=512,preallocation=metadata ...</p>

<p>-q --quiet This disables progress bars and other
unnecessary output.</p>

<p>--tmp block_device --tmp dir In copying mode only, use
the named device or directory as the location of the
temporary overlay (see also &quot;TMPDIR&quot; below).</p>

<p>If the parameter given is a block device, then the block
device is written to directly. Note this erases the existing
contents of the block device.</p>

<p>If the parameter is a directory, then this is the same
as setting the &quot;TMPDIR&quot; environment variable.</p>

<p>--tmp prebuilt:file In copying mode only, the
specialized option --tmp prebuilt:file (where
&quot;prebuilt:&quot; is a literal string) causes
virt-sparsify to use the qcow2 &quot;file&quot; as temporary
space.</p>

<p>&middot; The file must be freshly formatted as qcow2,
with indisk as the backing file.</p>

<p>&middot; If you rerun virt-sparsify, you must recreate
the file before each run.</p>

<p>&middot; Virt-sparsify does not delete the file.</p>

<p>This option is used by oVirt which requires a specially
formatted temporary file.</p>

<p>-v --verbose Enable verbose messages for debugging.</p>

<p>-V --version Display version number and exit.</p>

<p>-x Enable tracing of libguestfs API calls.</p>

<p>--zero partition --zero logvol Zero the contents of the
named partition or logical volume in the guest. All data on
the device is lost, but sparsification is excellent! You can
give this option multiple times.</p>

<p>MACHINE READABLE OUTPUT The --machine-readable option
can be used to make the output more machine friendly, which
is useful when calling virt-sparsify from other programs,
GUIs etc.</p>

<p>There are two ways to use this option.</p>

<p>Firstly use the option on its own to query the
capabilities of the virt-sparsify binary. Typical output
looks like this:</p>

<p>$ virt-sparsify --machine-readable virt-sparsify ntfs
btrfs</p>

<p>A list of features is printed, one per line, and the
program exits with status 0.</p>

<p>Secondly use the option in conjunction with other
options to make the regular program output more machine
friendly.</p>

<p>At the moment this means:</p>

<p>1. Progress bar messages can be parsed from stdout by
looking for this regular expression:</p>

<p>^[0-9]+/[0-9]+$</p>

<p>2. The calling program should treat messages sent to
stdout (except for progress bar messages) as status
messages. They can be logged and/or displayed to the
user.</p>

<p>3. The calling program should treat messages sent to
stderr as error messages. In addition, virt-sparsify exits
with a non-zero status code if there was a fatal error.</p>

<p>All versions of virt-sparsify have supported the
--machine-readable option.</p>

<p>WINDOWS 8 Windows 8 &quot;fast startup&quot; can prevent
virt-sparsify from working. See &quot;WINDOWS HIBERNATION
AND WINDOWS 8 FAST STARTUP&quot; in guestfs(3).</p>

<p>EXIT STATUS This program returns 0 if successful, or
non-zero if there was an error.</p>

<p>ENVIRONMENT VARIABLES TMPDIR Location of the temporary
directory used for the potentially large temporary overlay
file.</p>

<p>You can override this environment variable using the
--tmp option.</p>

<p>You should ensure there is enough free space in the
worst case for a full copy of the source disk (virtual
size), or else set $TMPDIR to point to another directory
that has enough space.</p>

<p>This defaults to &quot;/tmp&quot;.</p>

<p>Note that if $TMPDIR is a tmpfs (eg. if &quot;/tmp&quot;
is on tmpfs, or if you use &quot;TMPDIR=/dev/shm&quot;),
tmpfs defaults to a maximum size of half of physical RAM. If
virt-sparsify exceeds this, it will hang. The solution is
either to use a real disk, or to increase the maximum size
of the tmpfs mountpoint, eg:</p>

<p>mount -o remount,size=10G /tmp</p>

<p>For other environment variables, see &quot;ENVIRONMENT
VARIABLES&quot; in guestfs(3).</p>

<p>SEE ALSO virt-filesystems(1), virt-df(1),
virt-resize(1), virt-rescue(1), guestfs(3), guestfish(1),
truncate(1), fallocate(1), qemu-img(1),
http://libguestfs.org/.</p>

<p>AUTHOR Richard W.M. Jones
http://people.redhat.com/~rjones/</p>

<p>COPYRIGHT Copyright (C) 2011-2012 Red Hat Inc.</p>

<p>LICENSE This program is free software; you can
redistribute it and/or modify it under the terms of the GNU
General Public License as published by the Free Software
Foundation; either version 2 of the License, or (at your
option) any later version.</p>

<p>This program is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY; without even the implied
warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE. See the GNU General Public License for more
details.</p>

<p>You should have received a copy of the GNU General
Public License along with this program; if not, write to the
Free Software Foundation, Inc., 51 Franklin Street, Fifth
Floor, Boston, MA 02110-1301 USA.</p>

<p>BUGS To get a list of bugs against libguestfs, use this
link:
https://bugzilla.redhat.com/buglist.cgi?component=libguestfs&amp;product=Virtualization+Tools</p>

<p>To report a new bug against libguestfs, use this link:
https://bugzilla.redhat.com/enter_bug.cgi?component=libguestfs&amp;product=Virtualization+Tools</p>

<p>When reporting a bug, please supply:</p>

<p>&middot; The version of libguestfs.</p>

<p>&middot; Where you got libguestfs (eg. which Linux
distro, compiled from source, etc)</p>

<p>&middot; Describe the bug accurately and give a way to
reproduce it.</p>

<p>&middot; Run libguestfs-test-tool(1) and paste the
complete, unedited output into the bug report.</p>

<p>libguestfs-1.20.11 2013-08-27 virt-sparsify(1)</p>
<hr>
</body>
</html>
