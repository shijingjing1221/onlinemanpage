<!-- Creator     : groff version 1.18.1.4 -->
<!-- CreationDate: Sat Nov 12 06:43:54 2016 -->
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta name="Content-Style" content="text/css">
<title></title>
</head>
<body>

<hr>

<p>virt-rescue(1) Virtualization Support virt-rescue(1)</p>

<p>NAME virt-rescue - Run a rescue shell on a virtual
machine</p>

<p>SYNOPSIS virt-rescue [--options] -d domname</p>

<p>virt-rescue [--options] -a disk.img [-a disk.img
...]</p>

<p>virt-rescue --suggest (-d domname | -a disk.img ...)</p>

<p>Old style:</p>

<p>virt-rescue [--options] domname</p>

<p>virt-rescue [--options] disk.img [disk.img ...]</p>

<p>WARNING You must not use &quot;virt-rescue&quot; on live
virtual machines. Doing so will probably result in disk
corruption in the VM. &quot;virt-rescue&quot; tries to stop
you from doing this, but doesnt catch all cases.</p>

<p>However if you use the --ro (read only) option, then you
can attach a shell to a live virtual machine. The results
might be strange or inconsistent at times but you wont get
disk corruption.</p>

<p>DESCRIPTION virt-rescue is like a Rescue CD, but for
virtual machines, and without the need for a CD. virt-rescue
gives you a rescue shell and some simple recovery tools
which you can use to examine or rescue a virtual machine or
disk image.</p>

<p>You can run virt-rescue on any virtual machine known to
libvirt, or directly on disk image(s):</p>

<p>virt-rescue -d GuestName</p>

<p>virt-rescue --ro -a /path/to/disk.img</p>

<p>virt-rescue -a /dev/sdc</p>

<p>For live VMs you must use the --ro option.</p>

<p>When you run virt-rescue on a virtual machine or disk
image, you are placed in an interactive bash shell where you
can use many ordinary Linux commands. What you see in
&quot;/&quot; (&quot;/bin&quot;, &quot;/lib&quot; etc) is
the rescue appliance. You must mount the virtual machine s
filesystems by hand. There is an empty directory called
&quot;/sysroot&quot; where you can mount filesystems.</p>

<p>You can get virt-rescue to suggest mount commands for
you by using the --suggest option (in another terminal):</p>

<p>$ virt-rescue --suggest -d Fedora15 Inspecting the
virtual machine or disk image ...</p>

<p>This disk contains one or more operating systems. You
can use these mount commands in virt-rescue (at the
&gt;&lt;rescue&gt; prompt) to mount the filesystems.</p>

<p># /dev/vg_f15x32/lv_root is the root of a linux
operating system # type: linux, distro: fedora, version:
15.0 # Fedora release 15 (Lovelock)</p>

<p>mount /dev/vg_f15x32/lv_root /sysroot/ mount /dev/vda1
/sysroot/boot mount --bind /dev /sysroot/dev mount --bind
/dev/pts /sysroot/dev/pts mount --bind /proc /sysroot/proc
mount --bind /sys /sysroot/sys</p>

<p>Another way is to list the logical volumes (with lvs(8))
and partitions (with parted(8)) and mount them by hand:</p>

<p>&gt;&lt;rescue&gt; lvs LV VG Attr LSize Origin Snap%
Move Log Copy% Convert lv_root vg_f15x32 -wi-a- 8.83G
lv_swap vg_f15x32 -wi-a- 992.00M &gt;&lt;rescue&gt; mount
/dev/vg_f15x32/lv_root /sysroot &gt;&lt;rescue&gt; mount
/dev/vda1 /sysroot/boot &gt;&lt;rescue&gt; ls /sysroot</p>

<p>Another command to list available filesystems is
virt-filesystems(1).</p>

<p>To run commands in a Linux guest (for example, grub),
you should chroot into the /sysroot directory first:</p>

<p>&gt;&lt;rescue&gt; chroot /sysroot</p>

<p>NOTES Virt-rescue can be used on any disk image file or
device, not just a virtual machine. For example you can use
it on a blank file if you want to partition that file
(although we would recommend using guestfish(1) instead as
it is more suitable for this purpose). You can even use
virt-rescue on things like SD cards.</p>

<p>You can get virt-rescue to give you scratch disk(s) to
play with. This is useful for testing out Linux utilities
(see --scratch).</p>

<p>Virt-rescue does not require root. You only need to run
it as root if you need root to open the disk image.</p>

<p>This tool is just designed for quick interactive hacking
on a virtual machine. For more structured access to a
virtual machine disk image, you should use guestfs(3). To
get a structured shell that you can use to make scripted
changes to guests, use guestfish(1).</p>

<p>OPTIONS --help Display brief help.</p>

<p>-a file --add file Add file which should be a disk image
from a virtual machine. If the virtual machine has multiple
block devices, you must supply all of them with separate -a
options.</p>

<p>The format of the disk image is auto-detected. To
override this and force a particular format use the
--format=.. option.</p>

<p>--append kernelopts Pass additional options to the
rescue kernel.</p>

<p>-c URI --connect URI If using libvirt, connect to the
given URI. If omitted, then we connect to the default
libvirt hypervisor.</p>

<p>If you specify guest block devices directly (-a), then
libvirt is not used at all.</p>

<p>-d guest --domain guest Add all the disks from the named
libvirt guest. Domain UUIDs can be used instead of
names.</p>

<p>--format=raw|qcow2|.. --format The default for the -a
option is to auto-detect the format of the disk image. Using
this forces the disk format for -a options which follow on
the command line. Using --format with no argument switches
back to auto-detection for subsequent -a options.</p>

<p>For example:</p>

<p>virt-rescue --format=raw -a disk.img</p>

<p>forces raw format (no auto-detection) for
&quot;disk.img&quot;.</p>

<p>virt-rescue --format=raw -a disk.img --format -a
another.img</p>

<p>forces raw format (no auto-detection) for
&quot;disk.img&quot; and reverts to auto-detection for
&quot;another.img&quot;.</p>

<p>If you have untrusted raw-format guest disk images, you
should use this option to specify the disk format. This
avoids a possible security problem with malicious guests
(CVE-2010-3851).</p>

<p>-m MB --memsize MB Change the amount of memory allocated
to the rescue system. The default is set by libguestfs and
is small but adequate for running system tools. The
occasional program might need more memory. The parameter is
specified in megabytes.</p>

<p>--network Enable QEMU user networking in the guest. See
&quot;NETWORK&quot;.</p>

<p>-r --ro Open the image read-only.</p>

<p>The option must always be used if the disk image or
virtual machine might be running, and is generally
recommended in cases where you dont need write access to the
disk.</p>

<p>See also &quot;OPENING DISKS FOR READ AND WRITE&quot; in
guestfish(1).</p>

<p>--scratch --scratch=N The --scratch option adds a large
scratch disk to the rescue appliance. --scratch=N adds
&quot;N&quot; scratch disks. The scratch disk(s) are deleted
automatically when virt-rescue exits.</p>

<p>You can also mix -a, -d and --scratch options. The
scratch disk(s) are added to the appliance in the order they
appear on the command line.</p>

<p>--selinux Enable SELinux in the rescue appliance. You
should read &quot;SELINUX&quot; in guestfs(3) before using
this option.</p>

<p>--smp N Enable N 2 virtual CPUs in the rescue
appliance.</p>

<p>--suggest Inspect the disk image and suggest what mount
commands should be used to mount the disks. You should use
the --suggest option in a second terminal, then paste the
commands into another virt-rescue.</p>

<p>This option implies --ro and is safe to use even if the
guest is up or if another virt-rescue is running.</p>

<p>-v --verbose Enable verbose messages for debugging.</p>

<p>-V --version Display version number and exit.</p>

<p>-w --rw This changes the -a and -d options so that disks
are added and mounts are done read-write.</p>

<p>See &quot;OPENING DISKS FOR READ AND WRITE&quot; in
guestfish(1).</p>

<p>-x Enable tracing of libguestfs API calls.</p>

<p>OLD-STYLE COMMAND LINE ARGUMENTS Previous versions of
virt-rescue allowed you to write either:</p>

<p>virt-rescue disk.img [disk.img ...]</p>

<p>or</p>

<p>virt-rescue guestname</p>

<p>whereas in this version you should use -a or -d
respectively to avoid the confusing case where a disk image
might have the same name as a guest.</p>

<p>For compatibility the old style is still supported.</p>

<p>NETWORK Adding the --network option enables QEMU user
networking in the rescue appliance. There are some
differences between user networking and ordinary
networking:</p>

<p>ping does not work Because the ICMP ECHO_REQUEST
protocol generally requires root in order to send the ping
packets, and because virt-rescue must be able to run as
non-root, QEMU user networking is not able to emulate the
ping(8) command. The ping command will appear to resolve
addresses but will not be able to send or receive any
packets. This does not mean that the network is not
working.</p>

<p>cannot receive connections QEMU user networking cannot
receive incoming connections.</p>

<p>making TCP connections The virt-rescue appliance needs
to be small and so does not include many network tools. In
particular there is no telnet(1) command. You can make TCP
connections from the shell using the magical
&quot;/dev/tcp/&lt;hostname&gt;/&lt;port&gt;&quot;
syntax:</p>

<p>exec 3&lt;&gt;/dev/tcp/redhat.com/80 echo &quot;GET
/&quot; &gt;&amp;3 cat &lt;&amp;3</p>

<p>See bash(1) for more details.</p>

<p>CAPTURING CORE DUMPS If you are testing a tool inside
virt-rescue and the tool (not virt- rescue) segfaults, it
can be tricky to capture the core dump outside virt-rescue
for later analysis. This section describes one way to do
this.</p>

<p>1. Create a scratch disk for core dumps:</p>

<p>truncate -s 4G /tmp/corefiles virt-format
--partition=mbr --filesystem=ext2 -a /tmp/corefiles
virt-filesystems -a /tmp/corefiles --all --long -h</p>

<p>2. When starting virt-rescue, attach the core files disk
last:</p>

<p>virt-rescue --rw [-a ...] -a /tmp/corefiles</p>

<p>NB. If you use the --ro option, then virt-rescue will
silently not write any core files to
&quot;/tmp/corefiles&quot;.</p>

<p>3. Inside virt-rescue, mount the core files disk. Note
replace &quot;/dev/sdb1&quot; with the last disk index. For
example if the core files disk is the last of four disks,
you would use &quot;/dev/sdd1&quot;.</p>

<p>&gt;&lt;rescue&gt; mkdir /tmp/mnt &gt;&lt;rescue&gt;
mount /dev/sdb1 /tmp/mnt</p>

<p>4. Enable core dumps in the rescue kernel:</p>

<p>&gt;&lt;rescue&gt; echo &rsquo;/tmp/mnt/core.%p&rsquo;
&gt; /proc/sys/kernel/core_pattern &gt;&lt;rescue&gt; ulimit
-Hc unlimited &gt;&lt;rescue&gt; ulimit -Sc unlimited</p>

<p>5. Run the tool that caused the core dump. The core dump
will be written to &quot;/tmp/mnt/core.PID&quot;.</p>

<p>&gt;&lt;rescue&gt; ls -l /tmp/mnt total 1628 -rw-------
1 root root 1941504 Dec 7 13:13 core.130 drwx------ 2 root
root 16384 Dec 7 13:00 lost+found</p>

<p>6. Before exiting virt-rescue, unmount (or at least
sync) the disks:</p>

<p>&gt;&lt;rescue&gt; umount /tmp/mnt &gt;&lt;rescue&gt;
exit</p>

<p>7. Outside virt-rescue, the core dump(s) can be removed
from the disk using guestfish(1). For example:</p>

<p>guestfish --ro -a /tmp/corefiles -m /dev/sda1
&gt;&lt;fs&gt; ll / &gt;&lt;fs&gt; download /core.NNN
/tmp/core.NNN</p>

<p>ENVIRONMENT VARIABLES Several environment variables
affect virt-rescue. See &quot;ENVIRONMENT VARIABLES&quot; in
guestfs(3) for the complete list.</p>

<p>SHELL QUOTING Libvirt guest names can contain arbitrary
characters, some of which have meaning to the shell such as
&quot;#&quot; and space. You may need to quote or escape
these characters on the command line. See the shell manual
page sh(1) for details.</p>

<p>FILES $HOME/.libguestfs-tools.rc
/etc/libguestfs-tools.conf This configuration file controls
the default read-only or read- write mode (--ro or
--rw).</p>

<p>See &quot;OPENING DISKS FOR READ AND WRITE&quot; in
guestfish(1).</p>

<p>SEE ALSO guestfs(3), guestfish(1), virt-cat(1),
virt-edit(1), virt-filesystems(1),
http://libguestfs.org/.</p>

<p>AUTHOR Richard W.M. Jones
http://people.redhat.com/~rjones/</p>

<p>COPYRIGHT Copyright (C) 2009-2013 Red Hat Inc.</p>

<p>LICENSE This program is free software; you can
redistribute it and/or modify it under the terms of the GNU
General Public License as published by the Free Software
Foundation; either version 2 of the License, or (at your
option) any later version.</p>

<p>This program is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY; without even the implied
warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE. See the GNU General Public License for more
details.</p>

<p>You should have received a copy of the GNU General
Public License along with this program; if not, write to the
Free Software Foundation, Inc., 51 Franklin Street, Fifth
Floor, Boston, MA 02110-1301 USA.</p>

<p>BUGS To get a list of bugs against libguestfs, use this
link:
https://bugzilla.redhat.com/buglist.cgi?component=libguestfs&amp;product=Virtualization+Tools</p>

<p>To report a new bug against libguestfs, use this link:
https://bugzilla.redhat.com/enter_bug.cgi?component=libguestfs&amp;product=Virtualization+Tools</p>

<p>When reporting a bug, please supply:</p>

<p>&middot; The version of libguestfs.</p>

<p>&middot; Where you got libguestfs (eg. which Linux
distro, compiled from source, etc)</p>

<p>&middot; Describe the bug accurately and give a way to
reproduce it.</p>

<p>&middot; Run libguestfs-test-tool(1) and paste the
complete, unedited output into the bug report.</p>

<p>libguestfs-1.20.11 2013-08-27 virt-rescue(1)</p>
<hr>
</body>
</html>
