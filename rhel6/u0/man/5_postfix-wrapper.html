<!-- Creator     : groff version 1.18.1.4 -->
<!-- CreationDate: Sat Nov 12 22:11:12 2016 -->
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta name="Content-Style" content="text/css">
<title></title>
</head>
<body>

<hr>

<p>POSTFIX-WRAPPER(5) POSTFIX-WRAPPER(5)</p>

<p>NAME postfix-wrapper - Postfix multi-instance API</p>

<p>DESCRIPTION Postfix versions 2.6 and later provide
support for multiple Postfix instances. Instances share
executable files and documentation, but have their own
directories for configuration, queue and data files.</p>

<p>This document describes how the familiar &quot;postfix
start&quot; etc. user interface can be used to manage one or
multiple Postfix instances, and gives details of an API to
coordinate activities between the postfix(1) command and a
multi-instance manager program.</p>

<p>With multi-instance support, the default Postfix
instance is always required. The config_directory parameters
default value specifies that instances configuration file
location.</p>

<p>GENERAL OPERATION Multi-instance support is backwards
compatible: when you run only one Postfix instance, commands
such as &quot;postfix start&quot; will not change behavior
at all.</p>

<p>Even with multiple Postfix instances, you can keep using
the same post- fix commands in boot scripts, upgrade
procedures, and other places. The commands do more work, but
humans are not forced to learn new tricks.</p>

<p>For example, to start all Postfix instances, use:</p>

<p># postfix start</p>

<p>Other postfix(1) commands also work as expected. For
example, to find out what Postfix instances exist in a
multi-instance configuration, use:</p>

<p># postfix status</p>

<p>This enumerates the status of all Postfix instances
within a multi- instance configuration.</p>

<p>MANAGING AN INDIVIDUAL POSTFIX INSTANCE To manage a
specific Postfix instance, specify its configuration direc-
tory on the postfix(1) command line:</p>

<p># postfix -c /path/to/config_directory command</p>

<p>Alternatively, the postfix(1) command accepts the
instance s configura- tion directory via the MAIL_CONFIG
environment variable (the -c com- mand-line option has
higher precedence).</p>

<p>When no Postfix instance information is specified, the
postfix(1) com- mand will operate on all Postfix
instances.</p>

<p>ENABLING POSTFIX(1) MULTI-INSTANCE MODE By default, the
postfix(1) command operates in single-instance mode. In this
mode the command invokes the postfix-script file directly
(cur- rently installed in the daemon directory). This file
contains the com- mands that start or stop one Postfix
instance, that upgrade the config- uration of one Postfix
instance, and so on.</p>

<p>When the postfix(1) command operates in multi-instance
mode as dis- cussed below, the command needs to execute
start, stop, etc. commands for each Postfix instance. This
multiplication of commands is handled by a multi-instance
manager program.</p>

<p>Turning on postfix(1) multi-instance mode goes as
follows: in the default Postfix instances main.cf file, 1)
specify the pathname of a multi-instance manager program
with the multi_instance_wrapper parame- ter; 2) populate the
multi_instance_directories parameter with the con-
figuration directory pathnames of additional Postfix
instances. For example:</p>

<p>/etc/postfix/main.cf: multi_instance_wrapper =
$daemon_directory/postfix-wrapper multi_instance_directories
= /etc/postfix-test</p>

<p>The $daemon_directory/postfix-wrapper file implements a
simple manager and contains instructions for creating
Postfix instances by hand. The postmulti(1) command provides
a more extensive implementation including support for
life-cycle management.</p>

<p>The multi_instance_directories and other main.cf
parameters are listed below in the CONFIGURATION PARAMETERS
section.</p>

<p>In multi-instance mode, the postfix(1) command invokes
the $multi_instance_wrapper command instead of the
postfix-script file. This multi-instance manager in turn
executes the postfix(1) command in single-instance mode for
each Postfix instance.</p>

<p>To illustrate the main ideas behind multi-instance
operation, below is an example of a simple but useful
multi-instance manager implementa- tion:</p>

<p>#!/bin/sh</p>

<p>: ${command_directory?&quot;do not invoke this command
directly&quot;}</p>

<p>POSTCONF=$command_directory/postconf
POSTFIX=$command_directory/postfix
instance_dirs=&lsquo;$POSTCONF -h multi_instance_directories
| sed s/,/ /&lsquo; || exit 1</p>

<p>err=0 for dir in $config_directory $instance_dirs do
case &quot;$1&quot; in stop|abort|flush|reload|drain) test
&quot;&lsquo;$POSTCONF -c $dir -h
multi_instance_enable&lsquo;&quot; = yes || continue;;
start) test &quot;&lsquo;$POSTCONF -c $dir -h
multi_instance_enable&lsquo;&quot; = yes || { $POSTFIX -c
$dir check || err=$? continue };; esac $POSTFIX -c $dir
&quot;$@&quot; || err=$? done</p>

<p>exit $err</p>

<p>PER-INSTANCE MULTI-INSTANCE MANAGER CONTROLS Each
Postfix instance has its own main.cf file with parameters
that control how the multi-instance manager operates on that
instance. This section discusses the most important
settings.</p>

<p>The setting &quot;multi_instance_enable = yes&quot;
allows the multi-instance manager to start (stop, etc.) the
corresponding Postfix instance. For safety reasons, this
setting is not the default.</p>

<p>The default setting &quot;multi_instance_enable =
no&quot; is useful for manual testing with &quot;postfix -c
/path/name start&quot; etc. The multi-instance manager will
not start such an instance, and it will skip commands such
as &quot;stop&quot; or &quot;flush&quot; that require a
running Postfix instance. The multi-instance manager will
execute commands such as &quot;check&quot;, &quot;set-per-
missions&quot; or &quot;upgrade-configuration&quot;, and it
will replace &quot;start&quot; by &quot;check&quot; so that
problems will be reported even when the instance is
disabled.</p>

<p>MAINTAINING SHARED AND NON-SHARED FILES Some files are
shared between Postfix instances, such as executables and
manpages, and some files are per-instance, such as
configuration files, mail queue files, and data files. See
the NON-SHARED FILES sec- tion below for a list of
per-instance files.</p>

<p>Before Postfix multi-instance support was implemented,
the executables, manpages, etc., have always been maintained
as part of the default Postfix instance.</p>

<p>With multi-instance support, we simply continue to do
this. Specifi- cally, a Postfix instance will not check or
update shared files when that instance s config_directory
value is listed with the default main.cf files
multi_instance_directories parameter.</p>

<p>The consequence of this approach is that the default
Postfix instance should be checked and updated before any
other instances.</p>

<p>MULTI-INSTANCE API SUMMARY Only the multi-instance
manager implements support for the multi_instance_enable
configuration parameter. The multi-instance man- ager will
start only Postfix instances whose main.cf file has
&quot;multi_instance_enable = yes&quot;. A setting of
&quot;no&quot; allows a Postfix instance to be tested by
hand.</p>

<p>The postfix(1) command operates on only one Postfix
instance when the -c option is specified, or when
MAIL_CONFIG is present in the process environment. This is
necessary to terminate recursion.</p>

<p>Otherwise, when the multi_instance_directories parameter
value is non- empty, the postfix(1) command executes the
command specified with the multi_instance_wrapper parameter,
instead of executing the commands in postfix-script.</p>

<p>The multi-instance manager skips commands such as
&quot;stop&quot; or &quot;reload&quot; that require a
running Postfix instance, when an instance does not have
&quot;multi_instance_enable = yes&quot;. This avoids false
error messages.</p>

<p>The multi-instance manager replaces a &quot;start&quot;
command by &quot;check&quot; when a Postfix instance s
main.cf file does not have &quot;multi_instance_enable =
yes&quot;. This substitution ensures that problems will be
reported even when the instance is disabled.</p>

<p>No Postfix command or script will update or check shared
files when its config_directory value is listed in the
default main.cfs multi_instance_directories parameter value.
Therefore, the default instance should be checked and
updated before any Postfix instances that depend on it.</p>

<p>Set-gid commands such as postdrop(1) and postqueue(1)
effectively append the multi_instance_directories parameter
value to the legacy alternate_config_directories parameter
value. The commands use this information to determine
whether a -c option or MAIL_CONFIG environment setting
specifies a legitimate value.</p>

<p>The legacy alternate_config_directories parameter
remains necessary for non-default Postfix instances that are
running different versions of Postfix, or that are not
managed together with the default Postfix instance.</p>

<p>ENVIRONMENT VARIABLES MAIL_CONFIG When present, this
forces the postfix(1) command to operate only on the
specified Postfix instance. This environment variable is
exported by the postfix(1) -c option, so that postfix(1)
com- mands in descendant processes will work correctly.</p>

<p>CONFIGURATION PARAMETERS The text below provides only a
parameter summary. See postconf(5) for more details.</p>

<p>multi_instance_directories (empty) An optional list of
non-default Postfix configuration directo- ries; these
directories belong to additional Postfix instances that
share the Postfix executable files and documentation with
the default Postfix instance, and that are started, stopped,
etc., together with the default Postfix instance.</p>

<p>multi_instance_wrapper (empty) The pathname of a
multi-instance manager command that the post- fix(1) command
invokes when the multi_instance_directories parameter value
is non-empty.</p>

<p>multi_instance_name (empty) The optional instance name
of this Postfix instance.</p>

<p>multi_instance_group (empty) The optional instance group
name of this Postfix instance.</p>

<p>multi_instance_enable (no) Allow this Postfix instance
to be started, stopped, etc., by a multi-instance
manager.</p>

<p>NON-SHARED FILES config_directory (seepostconf -doutput)
The default location of the Postfix main.cf and master.cf
con- figuration files.</p>

<p>data_directory (seepostconf -doutput) The directory with
Postfix-writable data files (for example: caches,
pseudo-random numbers).</p>

<p>queue_directory (seepostconf -doutput) The location of
the Postfix top-level queue directory.</p>

<p>SEE ALSO postfix(1) Postfix control program postmulti(1)
full-blown multi-instance manager
$daemon_directory/postfix-wrapper simple multi-instance
manager</p>

<p>LICENSE The Secure Mailer license must be distributed
with this software.</p>

<p>AUTHOR(S) Wietse Venema IBM T.J. Watson Research P.O.
Box 704 Yorktown Heights, NY 10598, USA</p>

<p>POSTFIX-WRAPPER(5)</p>
<hr>
</body>
</html>
