<!-- Creator     : groff version 1.18.1.4 -->
<!-- CreationDate: Sat Nov 12 21:59:33 2016 -->
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta name="Content-Style" content="text/css">
<title></title>
</head>
<body>

<hr>

<p>FEBOOTSTRAP-TO-SUPERMIN(8) Virtualization Support
FEBOOTSTRAP-TO-SUPERMIN(8)</p>

<p>NAME febootstrap-to-supermin - Convert febootstrap root
to supermin appliance.</p>

<p>SYNOPSIS febootstrap-to-supermin DIR supermin.img
hostfiles.txt</p>

<p>DESCRIPTION febootstrap-to-supermin converts the
filesystem created by febootstrap(8) into a supermin
appliance. The term &quot;supermin appliance&quot; is
described in the documentation below. First you should be
familiar with febootstrap(8) and
febootstrap-to-initramfs(8).</p>

<p>PARAMETERS &quot;DIR&quot; is the directory created by
febootstrap (ie. the output of febootstrap and the input to
this program).</p>

<p>&quot;supermin.img&quot; is the name of the supermin
appliance that this program creates, and
&quot;hostfiles.txt&quot; is the name of the list of
hostfiles that this program creates. (ie. the outputs of
this program).</p>

<p>SUPERMIN APPLIANCE A supermin appliance is a very
specialized, highly minimized appliance which can be
reconstructed on-the-fly at runtime into an ordinary
(initramfs) appliance.</p>

<p>The normal appliance is a self-contained Linux operating
system, based on the Fedora/RHEL/CentOS Linux distro. So it
contains a complete copy of all the libraries and programs
needed, like kernel, libc, bash, coreutils etc etc.</p>

<p>The supermin appliance removes the kernel and all the
executable libraries and programs from the appliance. That
just leaves a skeleton of directories, config files and some
data files, which is obviously massively smaller than the
normal appliance. At runtime we rebuild the appliance
on-the-fly from the libraries and programs on the host (eg.
pulling in the real /lib/libc.so, the real /bin/bash
etc.)</p>

<p>Although this process of rebuilding the appliance each
time sounds slow, it turns out to be faster than using a
prebuilt appliance. (Most of the saving comes from not
compressing the appliance - it transpires that decompressing
the appliance is the slowest part of the whole boot
sequence). On my machine, a new appliance can be built in
under a fifth of a second, and the boot time is several
seconds shorter.</p>

<p>The big advantage of the supermin appliance for
distributions like Fedora is that it gets security fixes
automatically from the host, so there is no need to rebuild
the whole appliance for a security update in some underlying
library.</p>

<p>There are several disadvantages:</p>

<p>It won t work at all except in very narrow, controlled
cases like the Fedora packaging case. We control the
dependencies of the appliance RPM tightly to ensure that the
required binaries are actually present on the host.</p>

<p>Furthermore there are certain unlikely changes in the
packages on the host which could break a supermin appliance,
eg. an updated library which depends on an additional data
file.</p>

<p>Also supermin appliances are subjected to changes in the
host kernel which might break compatibility with qemu --
these are, of course, real bugs in any case.</p>

<p>Lastly, supermin appliances really cant be moved between
branches of distributions (eg. built on Fedora 12 and moved
to Fedora 10) because they are not self-contained and they
rely on certain libraries being around. You shouldnt do this
anyway.</p>

<p>Use supermin appliances with caution.</p>

<p>ANATOMY OF A SUPERMIN APPLIANCE A supermin appliance
consists usually of just two files, but can contain several
files and directories from the list below:</p>

<p>supermin.img The image file (conventionally called
&quot;supermin.img&quot;, but you can call it anything you
want) is the skeleton initramfs. This is like an initramfs
built by febootstrap-to-initramfs(8), but all libraries and
binaries are removed.</p>

<p>Note that this file is a cpio file in cpio
&quot;newc&quot; format, and is not compressed (unlike
initramfs files which are compressed cpio files).</p>

<p>hostfiles.txt This plain text file contains a list of
files that we need to add back from the host at runtime. ie.
Its the list of libraries and binaries that we removed when
we constructed &quot;supermin.img&quot;.</p>

<p>This file usually contains wildcards. This is because we
dont want the file to break on minor updates to libraries,
so for example instead of listing</p>

<p>lib64/libreadline.so.6.1.2</p>

<p>the file contains</p>

<p>lib64/libreadline.so.6.*</p>

<p>any directory You can specify a directory which should
contain image file(s) and hostfile(s).</p>

<p>Using a directory is useful either to keep the
appliance-related files together, or to make more complex
appliances containing optional bits.</p>

<p>RECONSTRUCTING AN INITRAMFS FROM A SUPERMIN APPLIANCE
The program febootstrap-supermin-helper(8) can be used to
reconstruct a full initramfs from &quot;supermin.img&quot;
and &quot;hostfiles.txt&quot; (plus, naturally, the required
programs and libraries in the host filesystem).</p>

<p>See that man page for details.</p>

<p>RESTRICTION: UNREADABLE BINARIES ON THE HOST Some
binaries on the host are not publically readable. For
example:</p>

<p>$ ll /usr/libexec/pt_chown -rws--x--x 1 root root 28418
2009-09-28 13:42 /usr/libexec/pt_chown $ ll /usr/bin/chsh
-rws--x--x 1 root root 18072 2009-10-05 16:28
/usr/bin/chsh</p>

<p>These binaries cause a problem when reconstructing the
supermin appliance, because we d like to copy them into the
final appliance, and usually that process is done as
non-root. Currently the only solution is that you should
remove these problematic binaries from the appliance.</p>

<p>EXAMPLE Create a basic Fedora directory and turn it into
a supermin image.</p>

<p>NB You must only build &quot;Rawhide on Rawhide&quot;.
If using another Fedora branch, you must change
&quot;rawhide&quot; below as appropriate, eg to
&quot;fedora-12&quot;.</p>

<p>$ febootstrap rawhide /tmp/fedora $
febootstrap-to-supermin /tmp/fedora supermin.img
hostfiles.txt</p>

<p>Examine the resulting files:</p>

<p>$ cpio -itv &lt; supermin.img | less $ less
hostfiles.txt</p>

<p>Reconstruct the final kernel and initramfs.</p>

<p>NB The first time you run this, it will be slow because
the required host files are not in cache. With a &quot;hot
cache&quot; it should be lightning fast. Run it several
times to get representative timings.</p>

<p>$ febootstrap-supermin-helper supermin.img hostfiles.txt
/tmp/kernel /tmp/initrd</p>

<p>You would boot the final image like this, although in
this example it probably won t work unless you add a
&quot;/init&quot; file to the appliance (see the discussion
in febootstrap-to-initramfs(8)).</p>

<p>$ qemu -m 1024 -kernel /tmp/kernel -initrd /tmp/initrd
[etc...]</p>

<p>SEE ALSO febootstrap(8), febootstrap-to-initramfs(8),
febootstrap-supermin-helper(8).</p>

<p>AUTHORS Richard W.M. Jones &lt;rjones @ redhat .
com&gt;</p>

<p>COPYRIGHT (C) Copyright 2009-2010 Red Hat Inc.,
&lt;http://people.redhat.com/~rjones/febootstrap&gt;.</p>

<p>This program is free software; you can redistribute it
and/or modify it under the terms of the GNU General Public
License as published by the Free Software Foundation; either
version 2 of the License, or (at your option) any later
version.</p>

<p>This program is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY; without even the implied
warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE. See the GNU General Public License for more
details.</p>

<p>You should have received a copy of the GNU General
Public License along with this program; if not, write to the
Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA
02139, USA.</p>

<p>febootstrap-2.7 2010-05-13
FEBOOTSTRAP-TO-SUPERMIN(8)</p>
<hr>
</body>
</html>
