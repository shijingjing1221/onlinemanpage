<!-- Creator     : groff version 1.22.2 -->
<!-- CreationDate: Sat Nov 12 01:03:52 2016 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>Mail::SpamAssassin::BayesStore::SQL</title>

</head>
<body>

<h1 align="center">Mail::SpamAssassin::BayesStore::SQL</h1>

<a href="#NAME">NAME</a><br>
<a href="#SYNOPSIS">SYNOPSIS</a><br>
<a href="#DESCRIPTION">DESCRIPTION</a><br>
<a href="#METHODS">METHODS</a><br>
<a href="#Private Methods">Private Methods</a><br>

<hr>


<h2>NAME
<a name="NAME"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em">Mail::SpamAssassin::BayesStore::SQL
&minus; SQL Bayesian Storage Module Implementation</p>

<h2>SYNOPSIS
<a name="SYNOPSIS"></a>
</h2>


<h2>DESCRIPTION
<a name="DESCRIPTION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">This module
implementes a <small>SQL</small> based bayesian storage
module.</p>

<h2>METHODS
<a name="METHODS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>new</b> <br>
public class (Mail::SpamAssassin::BayesStore::SQL) new
(Mail::Spamassassin::Plugin::Bayes <tt>$bayes</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This methods creates a new instance of the
Mail::SpamAssassin::BayesStore::SQL object. It expects to be
passed an instance of the Mail::SpamAssassin:Bayes object
which is passed into the Mail::SpamAssassin::BayesStore
parent object.</p>

<p style="margin-left:11%; margin-top: 1em">This method
sets up the database connection and determines the username
to use in queries.</p>


<p style="margin-left:11%; margin-top: 1em"><b>tie_db_readonly</b>
<br>
public instance (Boolean) tie_db_readonly ();</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method ensures that the database connection is properly
setup and working. If necessary it will initialize a
user&rsquo;s bayes variables so that they can begin using
the database immediately.</p>


<p style="margin-left:11%; margin-top: 1em"><b>tie_db_writable</b>
<br>
public instance (Boolean) tie_db_writable ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method ensures that the database connection is properly
setup and working. If necessary it will initialize a users
bayes variables so that they can begin using the database
immediately.</p>


<p style="margin-left:11%; margin-top: 1em"><b>untie_db</b>
<br>
public instance () untie_db ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
Disconnects from an <small>SQL</small> server.</p>


<p style="margin-left:11%; margin-top: 1em"><b>calculate_expire_delta</b>
<br>
public instance (%) calculate_expire_delta (Integer
<tt>$newest_atime</tt>, <br>
Integer <tt>$start</tt>, <br>
Integer <tt>$max_expire_mult</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method performs a calculation on the data to determine
the optimum atime for token expiration.</p>


<p style="margin-left:11%; margin-top: 1em"><b>token_expiration</b>
<br>
public instance (Integer, Integer, <br>
Integer, Integer) token_expiration(\% <tt>$opts</tt>, <br>
Integer <tt>$newdelta</tt>, <br>
@ <tt>@vars</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method performs the database specific expiration of
tokens based on the passed in <tt>$newdelta</tt> and
<tt>@vars</tt>.</p>


<p style="margin-left:11%; margin-top: 1em"><b>sync_due</b>
<br>
public instance (Boolean) sync_due ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method determines if a database sync is currently
required.</p>

<p style="margin-left:11%; margin-top: 1em">Unused for
<small>SQL</small> based implementation.</p>


<p style="margin-left:11%; margin-top: 1em"><b>seen_get</b>
<br>
public instance (String) seen_get (string
<tt>$msgid</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method retrieves the stored value, if any, for
<tt>$msgid</tt>. The return value is the stored string
(&rsquo;s&rsquo; for spam and &rsquo;h&rsquo; for ham) or
undef if <tt>$msgid</tt> is not found.</p>


<p style="margin-left:11%; margin-top: 1em"><b>seen_put</b>
<br>
public (Boolean) seen_put (string <tt>$msgid</tt>, char
<tt>$flag</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method records <tt>$msgid</tt> as the type given by
<tt>$flag</tt>. <tt>$flag</tt> is one of two values
&rsquo;s&rsquo; for spam and &rsquo;h&rsquo; for ham.</p>


<p style="margin-left:11%; margin-top: 1em"><b>seen_delete</b>
<br>
public instance (Boolean) seen_delete (string
<tt>$msgid</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method removes <tt>$msgid</tt> from the database.</p>


<p style="margin-left:11%; margin-top: 1em"><b>get_storage_variables</b>
<br>
public instance (@) get_storage_variables ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method retrieves the various administrative variables
used by the Bayes process and database.</p>

<p style="margin-left:11%; margin-top: 1em">The values
returned in the array are in the following order:</p>

<p style="margin-left:11%; margin-top: 1em">0: scan count
base</p>

<p style="margin-left:11%; margin-top: 1em">1: number of
spam</p>

<p style="margin-left:11%; margin-top: 1em">2: number of
ham</p>

<p style="margin-left:11%; margin-top: 1em">3: number of
tokens in db</p>

<p style="margin-left:11%; margin-top: 1em">4: last expire
atime</p>

<p style="margin-left:11%; margin-top: 1em">5: oldest token
in db atime</p>

<p style="margin-left:11%; margin-top: 1em">6: db version
value</p>

<p style="margin-left:11%; margin-top: 1em">7: last journal
sync</p>

<p style="margin-left:11%; margin-top: 1em">8: last atime
delta</p>

<p style="margin-left:11%; margin-top: 1em">9: last expire
reduction count</p>

<p style="margin-left:11%; margin-top: 1em">10: newest
token in db atime</p>


<p style="margin-left:11%; margin-top: 1em"><b>dump_db_toks</b>
<br>
public instance () dump_db_toks (String <tt>$template</tt>,
String <tt>$regex</tt>, Array <tt>@vars</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method loops over all tokens, computing the probability
for the token and then printing it out according to the
passed in token.</p>


<p style="margin-left:11%; margin-top: 1em"><b>set_last_expire</b>
<br>
public instance (Boolean) set_last_expire (Integer
<tt>$time</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method sets the last expire time.</p>


<p style="margin-left:11%; margin-top: 1em"><b>get_running_expire_tok</b>
<br>
public instance (String <tt>$time</tt>)
get_running_expire_tok ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method determines if an expire is currently running and
returns the last time set.</p>

<p style="margin-left:11%; margin-top: 1em">There can be
multiple times, so we just pull the greatest (most recent)
value.</p>


<p style="margin-left:11%; margin-top: 1em"><b>set_running_expire_tok</b>
<br>
public instance (String <tt>$time</tt>)
set_running_expire_tok ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method sets the time that an expire starts running.</p>


<p style="margin-left:11%; margin-top: 1em"><b>remove_running_expire_tok</b>
<br>
public instance (Boolean) remove_running_expire_tok ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method removes the row in the database that indicates
that and expire is currently running.</p>

<p style="margin-left:11%; margin-top: 1em"><b>tok_get</b>
<br>
public instance (Integer, Integer, Integer) tok_get (String
<tt>$token</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method retrieves a specificed token (<tt>$token</tt>)
from the database and returns it&rsquo;s spam_count,
ham_count and last access time.</p>


<p style="margin-left:11%; margin-top: 1em"><b>tok_get_all</b>
<br>
public instance (\@) tok_get (@ <tt>$tokens</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method retrieves the specified tokens
(<tt>$tokens</tt>) from storage and returns an array ref of
arrays spam count, ham acount and last access time.</p>


<p style="margin-left:11%; margin-top: 1em"><b>tok_count_change</b></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="-3%"></td>
<td width="7%">


<p>public instance (Boolean) tok_count_change (Integer
<tt>$spam_count</tt>,</p> </td>
<td width="8%">
</td>
<td width="8%">
</td>
<td width="7%">
</td>
<td width="8%">
</td>
<td width="54%">


<p>Integer <tt>$ham_count</tt>,</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="-3%"></td>
<td width="7%"></td>
<td width="8%">
</td>
<td width="8%">
</td>
<td width="7%">
</td>
<td width="8%">
</td>
<td width="54%">


<p>String <tt>$token</tt>,</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="-3%"></td>
<td width="7%"></td>
<td width="8%">
</td>
<td width="8%">
</td>
<td width="7%">
</td>
<td width="8%">
</td>
<td width="54%">


<p>String <tt>$atime</tt>)</p></td></tr>
</table>

<p style="margin-left:11%; margin-top: 1em">Description:
This method takes a <tt>$spam_count</tt> and
<tt>$ham_count</tt> and adds it to <tt>$tok</tt> along with
updating <tt>$tok</tt>s atime with <tt>$atime</tt>.</p>


<p style="margin-left:11%; margin-top: 1em"><b>multi_tok_count_change</b>
<br>
public instance (Boolean) multi_tok_count_change (Integer
<tt>$spam_count</tt>,</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="8%"></td>
<td width="7%">
</td>
<td width="8%">
</td>
<td width="8%">
</td>
<td width="7%">
</td>
<td width="8%">
</td>
<td width="54%">


<p>Integer <tt>$ham_count</tt>,</p></td></tr>
<tr valign="top" align="left">
<td width="8%"></td>
<td width="7%"></td>
<td width="8%">
</td>
<td width="8%">
</td>
<td width="7%">
</td>
<td width="8%">
</td>
<td width="54%">


<p>\% <tt>$tokens</tt>,</p></td></tr>
<tr valign="top" align="left">
<td width="8%"></td>
<td width="7%"></td>
<td width="8%">
</td>
<td width="8%">
</td>
<td width="7%">
</td>
<td width="8%">
</td>
<td width="54%">


<p>String <tt>$atime</tt>)</p></td></tr>
</table>

<p style="margin-left:11%; margin-top: 1em">Description:
This method takes a <tt>$spam_count</tt> and
<tt>$ham_count</tt> and adds it to all of the tokens in the
<tt>$tokens</tt> hash ref along with updating each
token&rsquo;s atime with <tt>$atime</tt>.</p>


<p style="margin-left:11%; margin-top: 1em"><b>nspam_nham_get</b>
<br>
public instance ($spam_count, <tt>$ham_count</tt>)
nspam_nham_get ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method retrieves the total number of spam and the total
number of ham learned.</p>


<p style="margin-left:11%; margin-top: 1em"><b>nspam_nham_change</b>
<br>
public instance (Boolean) nspam_nham_change (Integer
<tt>$num_spam</tt>, <br>
Integer <tt>$num_ham</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method updates the number of spam and the number of ham
in the database.</p>


<p style="margin-left:11%; margin-top: 1em"><b>tok_touch</b>
<br>
public instance (Boolean) tok_touch (String <tt>$token</tt>,
<br>
String <tt>$atime</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method updates the given tokens (<tt>$token</tt>)
atime.</p>

<p style="margin-left:11%; margin-top: 1em">The assumption
is that the token already exists in the database.</p>


<p style="margin-left:11%; margin-top: 1em"><b>tok_touch_all</b>
<br>
public instance (Boolean) tok_touch (\@ <tt>$tokens</tt>
<br>
String <tt>$atime</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method does a mass update of the given list of tokens
<tt>$tokens</tt>, if the existing token atime is &lt;
<tt>$atime</tt>.</p>

<p style="margin-left:11%; margin-top: 1em">The assumption
is that the tokens already exist in the database.</p>

<p style="margin-left:11%; margin-top: 1em">We should never
be touching more than N_SIGNIFICANT_TOKENS, so we can make
some assumptions about how to handle the data (ie no need to
batch like we do in tok_get_all)</p>

<p style="margin-left:11%; margin-top: 1em"><b>cleanup</b>
<br>
public instance (Boolean) cleanup ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method perfoms any cleanup necessary before moving onto
the next operation.</p>


<p style="margin-left:11%; margin-top: 1em"><b>get_magic_re</b>
<br>
public instance get_magic_re (String)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method returns a regexp which indicates a magic
token.</p>

<p style="margin-left:11%; margin-top: 1em">Unused in
<small>SQL</small> implementation.</p>

<p style="margin-left:11%; margin-top: 1em"><b>sync</b>
<br>
public instance (Boolean) sync (\% <tt>$opts</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method performs a sync of the database</p>


<p style="margin-left:11%; margin-top: 1em"><b>perform_upgrade</b>
<br>
public instance (Boolean) perform_upgrade (\%
<tt>$opts</tt>);</p>

<p style="margin-left:11%; margin-top: 1em">Description:
Performs an upgrade of the database from one version to
another, not currently used in this implementation.</p>


<p style="margin-left:11%; margin-top: 1em"><b>clear_database</b>
<br>
public instance (Boolean) clear_database ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method deletes all records for a particular user.</p>

<p style="margin-left:11%; margin-top: 1em">Callers should
be aware that any errors returned by this method could cause
the database to be inconsistent for the given user.</p>


<p style="margin-left:11%; margin-top: 1em"><b>backup_database</b>
<br>
public instance (Boolean) backup_database ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method will dump the users database in a machine
readable format.</p>


<p style="margin-left:11%; margin-top: 1em"><b>restore_database</b>
<br>
public instance (Boolean) restore_database (String
<tt>$filename</tt>, Boolean <tt>$showdots</tt>)</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method restores a database from the given filename,
<tt>$filename</tt>.</p>

<p style="margin-left:11%; margin-top: 1em">Callers should
be aware that any errors returned by this method could
causes the database to be inconsistent for the given
user.</p>


<p style="margin-left:11%; margin-top: 1em"><b>db_readable</b>
<br>
public instance (Boolean) <i>db_readable()</i></p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method returns a boolean value indicating if the
database is in a readable state.</p>


<p style="margin-left:11%; margin-top: 1em"><b>db_writable</b>
<br>
public instance (Boolean) <i>db_writeable()</i></p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method returns a boolean value indicating if the
database is in a writable state.</p>

<h2>Private Methods
<a name="Private Methods"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>_connect_db</b>
<br>
private instance (Boolean) _connect_db ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method connects to the <small>SQL</small> database.</p>


<p style="margin-left:11%; margin-top: 1em"><b>_get_db_version</b>
<br>
private instance (Integer) _get_db_version ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
Gets the current version of the database from the special
global vars tables.</p>


<p style="margin-left:11%; margin-top: 1em"><b>_initialize_db</b>
<br>
private instance (Boolean) _initialize_db ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method will check to see if a user has had their bayes
variables initialized. If not then it will perform this
initialization.</p>


<p style="margin-left:11%; margin-top: 1em"><b>_put_token</b>
<br>
private instance (Boolean) _put_token (string
<tt>$token</tt>, <br>
integer <tt>$spam_count</tt>,</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">


<p>integer <tt>$ham_count</tt>, string <tt>$atime</tt>)</p></table>

<p style="margin-left:11%; margin-top: 1em">Description:
This method performs the work of either inserting or
updating a token in the database.</p>


<p style="margin-left:11%; margin-top: 1em"><b>_put_tokens</b>
<br>
private instance (Boolean) _put_tokens (\% <tt>$tokens</tt>,
<br>
integer <tt>$spam_count</tt>,</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">


<p>integer <tt>$ham_count</tt>, string <tt>$atime</tt>)</p></table>

<p style="margin-left:11%; margin-top: 1em">Description:
This method performs the work of either inserting or
updating tokens in the database.</p>


<p style="margin-left:11%; margin-top: 1em"><b>_get_oldest_token_age</b>
<br>
private instance (Integer) _get_oldest_token_age ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method finds the atime of the oldest token in the
database.</p>

<p style="margin-left:11%; margin-top: 1em">The use of
min(atime) in the <small>SQL</small> is ugly and but really
the most efficient way of getting the oldest_token_age after
we&rsquo;ve done a mass expire. It should only be called at
expire time.</p>


<p style="margin-left:11%; margin-top: 1em"><b>_get_num_hapaxes</b>
<br>
private instance (Integer) _get_num_hapaxes ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method gets the total number of hapaxes (spam_count +
ham_count == 1) in the token database for a user.</p>


<p style="margin-left:11%; margin-top: 1em"><b>_get_num_lowfreq</b>
<br>
private instance (Integer) _get_num_lowfreq ()</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method gets the total number of lowfreq tokens
(spam_count &lt; 8 and ham_count &lt; 8) in the token
database for a user</p>


<p style="margin-left:11%; margin-top: 1em"><b>_token_select_string</b>
<br>
private instance (String) _token_select_string</p>

<p style="margin-left:11%; margin-top: 1em">Description:
This method returns the string to be used in
<small>SELECT</small> statements to represent the token
column.</p>

<p style="margin-left:11%; margin-top: 1em">The default is
to use the <small>RPAD</small> function to pad the token out
to 5 characters.</p>
<hr>
</body>
</html>
