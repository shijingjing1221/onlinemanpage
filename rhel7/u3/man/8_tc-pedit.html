<!-- Creator     : groff version 1.22.2 -->
<!-- CreationDate: Fri Nov 11 22:05:57 2016 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>Generic packet editor action in tc</title>

</head>
<body>

<h1 align="center">Generic packet editor action in tc</h1>

<a href="#NAME">NAME</a><br>
<a href="#SYNOPSIS">SYNOPSIS</a><br>
<a href="#DESCRIPTION">DESCRIPTION</a><br>
<a href="#OPTIONS">OPTIONS</a><br>
<a href="#EXAMPLES">EXAMPLES</a><br>
<a href="#SEE ALSO">SEE ALSO</a><br>

<hr>


<h2>NAME
<a name="NAME"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">pedit - generic
packet editor action</p>

<h2>SYNOPSIS
<a name="SYNOPSIS"></a>
</h2>


<p style="margin-left:23%; margin-top: 1em"><b>tc</b> ...
<b>action pedit munge</b> { <i>RAW_OP</i> |
<i>LAYERED_OP</i> } [ <i>CONTROL</i> ]</p>

<p style="margin-left:23%; margin-top: 1em"><i>RAW_OP</i>
:= <b>offset</b> <i>OFFSET</i> { <b>u8</b> | <b>u16</b> |
<b>u32</b> } [ <i>AT_SPEC</i> ] <i>CMD_SPEC</i></p>

<p style="margin-left:23%; margin-top: 1em"><i>AT_SPEC</i>
:= <b>at</b> <i>AT</i> <b>offmask</b> <i>MASK</i>
<b>shift</b> <i>SHIFT</i></p>


<p style="margin-left:23%; margin-top: 1em"><i>LAYERED_OP</i>
:= { <b>ip</b> <i>IPHDR_FIELD</i> | <b>ip6</b>
<i>IP6HDR_FIELD</i> | <b>udp</b> <i>UDPHDR_FIELD</i> |
<b>tcp</b> <i>TCPHDR_FIELD</i> | <b>icmp</b>
<i>ICMPHDR_FIELD</i> } <i>CMD_SPEC</i></p>


<p style="margin-left:23%; margin-top: 1em"><i>IPHDR_FIELD</i>
:= { <b>src</b> | <b>dst</b> | <b>tos</b> | <b>dsfield</b> |
<b>ihl</b> | <b>protocol</b> | <b>precedence</b> |
<b>nofrag</b> | <b>firstfrag</b> | <b>ce</b> | <b>df</b> |
<b>mf</b> | <b>dport</b> | <b>sport</b> | <b>icmp_type</b> |
<b>icmp_code</b> }</p>


<p style="margin-left:23%; margin-top: 1em"><i>CMD_SPEC</i>
:= { <b>clear</b> | <b>invert</b> | <b>set</b> <i>VAL</i> |
<b>preserve</b> } [ <b>retain</b> <i>RVAL</i> ]</p>

<p style="margin-left:23%; margin-top: 1em"><i>CONTROL</i>
:= { <b>reclassify</b> | <b>pipe</b> | <b>drop</b> |
<b>shot</b> | <b>continue</b> | <b>pass</b> }</p>

<h2>DESCRIPTION
<a name="DESCRIPTION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The
<b>pedit</b> action can be used to change arbitrary packet
data. The location of data to change can either be specified
by giving an offset and size as in <i>RAW_OP</i>, or for
header values by naming the header and field to edit the
size is then chosen automatically based on the header field
size. Currently this is supported only for IPv4 headers.</p>

<h2>OPTIONS
<a name="OPTIONS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>offset</b>
<i>OFFSET</i> { <b>u32</b> | <b>u16</b> | <b>u8</b> }</p>

<p style="margin-left:22%;">Specify the offset at which to
change data. <i>OFFSET</i> is a signed integer, it&rsquo;s
base is automatically chosen (e.g. hex if prefixed by
<b>0x</b> or octal if prefixed by <b>0</b>). The second
argument specifies the length of data to change, that is
four bytes (<b>u32</b>), two bytes (<b>u16</b>) or a single
byte (<b>u8</b>).</p>

<p style="margin-left:11%;"><b>at</b> <i>AT</i>
<b>offmask</b> <i>MASK</i> <b>shift</b> <i>SHIFT</i></p>

<p style="margin-left:22%;">This is an optional part of
<i>RAW_OP</i> which allows to have a variable <i>OFFSET</i>
depending on packet data at offset <i>AT</i>, which is
binary ANDed with <i>MASK</i> and right-shifted by
<i>SHIFT</i> before adding it to <i>OFFSET</i>.</p>

<p style="margin-left:11%;"><b>ip</b>
<i>IPHDR_FIELD</i></p>

<p style="margin-left:22%;">Change an IPv4 header field.
The supported keywords for <i>IPHDR_FIELD</i> are:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="22%"></td>
<td width="4%">


<p><b>src</b></p></td>
<td width="6%"></td>
<td width="68%">
</td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="4%">


<p><b>dst</b></p></td>
<td width="6%"></td>
<td width="68%">


<p>Source or destination IP address, a four-byte value.</p></td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="4%">


<p><b>tos</b></p></td>
<td width="6%"></td>
<td width="68%">
</td></tr>
</table>

<p style="margin-left:22%;"><b>dsfield <br>
precedence</b></p>

<p style="margin-left:32%;">Type Of Service field, an
eight-bit value.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="22%"></td>
<td width="4%">


<p><b>ihl</b></p></td>
<td width="6%"></td>
<td width="68%">


<p>Change the IP Header Length field, a four-bit value.</p></td></tr>
</table>

<p style="margin-left:22%;"><b>protocol</b></p>

<p style="margin-left:32%;">Next-layer Protocol field, an
eight-bit value.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="22%"></td>
<td width="9%">


<p><b>nofrag</b></p></td>
<td width="69%">
</td></tr>
</table>

<p style="margin-left:22%;"><b>firstfrag</b></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="22%"></td>
<td width="7%">


<p><b>ce</b></p></td>
<td width="3%"></td>
<td width="68%">
</td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="7%">


<p><b>df</b></p></td>
<td width="3%"></td>
<td width="68%">
</td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="7%">


<p><b>mf</b></p></td>
<td width="3%"></td>
<td width="68%">


<p>Change IP header flags. Note that the value to pass to
the <b>set</b> command is not just a bit value, but the full
byte including the flags field. Though only the relevant
bits of that value are respected, the rest ignored.</p></td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="7%">


<p><b>dport</b></p></td>
<td width="3%"></td>
<td width="68%">
</td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="7%">


<p><b>sport</b></p></td>
<td width="3%"></td>
<td width="68%">


<p>Destination or source port numbers, a 16-bit value.
Indeed, IPv4 headers don&rsquo;t contain this information.
Instead, this will set an offset which suits at least TCP
and UDP if the IP header is of minimum size (20 bytes). If
not, this will do unexpected things.</p></td></tr>
</table>

<p style="margin-left:22%;"><b>icmp_type <br>
icmp_code</b></p>

<p style="margin-left:32%;">Again, this allows to change
data past the actual IP header itself. It assumes an ICMP
header is present immediately following the (minimal sized)
IP header. If it is not or the latter is bigger than the
minimum of 20 bytes, this will do unexpected things. These
fields are eight-bit values.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="9%">


<p><b>clear</b></p></td>
<td width="2%"></td>
<td width="73%">


<p>Clear the addressed data (i.e., set it to zero).</p></td>
<td width="5%">
</td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="9%">


<p><b>invert</b></p></td>
<td width="2%"></td>
<td width="73%">


<p>Swap every bit in the addressed data.</p></td>
<td width="5%">
</td></tr>
</table>

<p style="margin-left:11%;"><b>set</b> <i>VAL</i></p>

<p style="margin-left:22%;">Set the addressed data to a
specific value. The size of <i>VAL</i> is defined by either
one of the <b>u32</b>, <b>u16</b> or <b>u8</b> keywords in
<i>RAW_OP</i>, or the size of the addressed header field in
<i>LAYERED_OP</i>.</p>

<p style="margin-left:11%;"><b>preserve</b></p>

<p style="margin-left:22%;">Keep the addressed data as
is.</p>

<p style="margin-left:11%;"><b>retain</b> <i>RVAL</i></p>

<p style="margin-left:22%;">This optional extra part of
<i>CMD_SPEC</i> allows to exclude bits from being
changed.</p>

<p style="margin-left:11%;"><i>CONTROL</i></p>

<p style="margin-left:22%;">The following keywords allow to
control how the tree of qdisc, classes, filters and actions
is further traversed after this action. <b><br>
reclassify</b></p>

<p style="margin-left:32%;">Restart with the first filter
in the current list.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="22%"></td>
<td width="6%">


<p><b>pipe</b></p></td>
<td width="4%"></td>
<td width="68%">


<p>Continue with the next action attached to the same
filter.</p> </td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="6%">


<p><b>drop</b></p></td>
<td width="4%"></td>
<td width="68%">
</td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="6%">


<p><b>shot</b></p></td>
<td width="4%"></td>
<td width="68%">


<p>Drop the packet.</p></td></tr>
</table>

<p style="margin-left:22%;"><b>continue</b></p>

<p style="margin-left:32%;">Continue classification with
the next filter in line.</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="22%"></td>
<td width="6%">


<p><b>pass</b></p></td>
<td width="4%"></td>
<td width="68%">


<p>Finish classification process and return to calling
qdisc for further packet processing. This is the
default.</p> </td></tr>
</table>

<h2>EXAMPLES
<a name="EXAMPLES"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Being able to
edit packet data, one could do all kinds of things, such as
e.g. implementing port redirection. Certainly not the most
useful application, but as an example it should do:</p>

<p style="margin-left:11%; margin-top: 1em">First, qdiscs
need to be set up to attach filters to. For the receive
path, a simple <b>ingress</b> qdisc will do, for transmit
path a classful qdisc (<b>HTB</b> in this case) is
necessary:</p>

<pre style="margin-left:22%; margin-top: 1em">tc qdisc replace dev eth0 root handle 1: htb
tc qdisc add dev eth0 ingress handle ffff:</pre>


<p style="margin-left:11%; margin-top: 1em">Finally, a
filter with <b>pedit</b> action can be added for each
direction. In this case, <b>u32</b> is used matching on the
port number to redirect from, while <b>pedit</b> then does
the actual rewriting:</p>

<pre style="margin-left:22%; margin-top: 1em">tc filter add dev eth0 parent 1: u32 \
     match ip dport 23 0xffff \
     action pedit pedit munge ip dport set 22
tc filter add dev eth0 parent ffff: u32 \
     match ip sport 22 0xffff \
     action pedit pedit munge ip sport set 23</pre>


<h2>SEE ALSO
<a name="SEE ALSO"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>tc</b>(8),
<b>tc-htb</b>(8), <b>tc-u32</b>(8)</p>
<hr>
</body>
</html>
