<!-- Creator     : groff version 1.22.2 -->
<!-- CreationDate: Fri Nov 11 20:42:37 2016 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>LIBPAF-EBB</title>

</head>
<body>

<h1 align="center">LIBPAF-EBB</h1>

<a href="#NAME">NAME</a><br>
<a href="#SYNOPSIS">SYNOPSIS</a><br>
<a href="#DESCRIPTION">DESCRIPTION</a><br>
<a href="#RETURN VALUE">RETURN VALUE</a><br>
<a href="#ERRORS">ERRORS</a><br>
<a href="#VERSIONS">VERSIONS</a><br>
<a href="#EXAMPLE">EXAMPLE</a><br>
<a href="#SEE ALSO">SEE ALSO</a><br>
<a href="#REFERENCES">REFERENCES</a><br>
<a href="#REPORTING BUGS">REPORTING BUGS</a><br>
<a href="#AUTHORS">AUTHORS</a><br>

<hr>


<h2>NAME
<a name="NAME"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">libpaf-ebb
&minus; The Power Architecture Facilities Event-Based Branch
Library</p>

<h2>SYNOPSIS
<a name="SYNOPSIS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>#include
&lt;paf/ebb.h&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>typedef void
(*ebbhandler_t)(void*);</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>int
paf_ebb_pmu_init(uint64_t</b> <i>raw_event</i><b>, int</b>
<i>group</i><b>);</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>void
paf_ebb_pmu_set_period(uint32_t</b>
<i>sample_period</i><b>);</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>void
paf_ebb_pmu_reset(void);</b></p>


<p style="margin-left:11%; margin-top: 1em"><b>ebbhandler_t
paf_ebb_register_handler(ebbhandler_t</b> <i>handler</i><b>,
void *</b> <i>context</i><b>, paf_ebb_callback_type_t</b>
<i>type</i><b>, int</b> <i>flags</i><b>);</b></p>


<p style="margin-left:11%; margin-top: 1em"><b>ebbhandler_t
paf_ebb_handler(void);</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>int
paf_ebb_enable_branches(void);</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>int
paf_ebb_disable_branches(void);</b></p>

<p style="margin-left:11%; margin-top: 1em">Compile and
link with <i>&minus;lpaf&minus;ebb</i>.</p>

<h2>DESCRIPTION
<a name="DESCRIPTION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The Power
Architecture&reg; Facilities <b>Event-Based Branch
Library</b> (<b>libpaf-ebb</b>) is a part of the Power
Architecture Facilities Library (<b>PAFLib</b>)</p>

<p style="margin-left:11%; margin-top: 1em">The Event-Based
Branch Library provides an easy-to-use framework for using
the Power Architecture Event-Based Branch facility
(<b>EBB</b>).</p>

<p style="margin-left:11%; margin-top: 1em">If enabled, the
EBB facility generates an <i>event-based exception</i> when
a user-specified event occurs, which causes the hardware to
branch directly to a user-space address (EBB handler). The
facility does not require any kernel handling besides
initialization. Only Performance Monitor Unit (PMU) events
are supported.</p>

<p style="margin-left:11%; margin-top: 1em">The Event-Based
Branch Library framework registers a proxy-handler with the
hardware, on behalf of a user program, so that the program
doesn&rsquo;t need to directly control the Power
Architecture EBB facility (which would require assembly
language instructions and an understanding of the EBB ELF
ABI).</p>

<p style="margin-left:11%; margin-top: 1em">The EBB Library
proxy-handler will properly stack an ELF ABI EBB exception
frame on the user-stack, preserve the current register
context in that stack frame, and then pass control to a user
registered (thread specific) handler. When the user-space
handler has completed its task and returned control to the
EBB Library proxy-handler, the proxy-handler will perform
the tasks necessary to restore the register context, pop the
EBB exception frame, and return control to the code that was
interrupted by the event-based exception.</p>


<p style="margin-left:11%; margin-top: 1em"><b>paf_ebb_pmu_init()</b>
initializes the PMU event generation configuring the
hardware counter <i>raw_event</i> with the specified
<i>group.</i> The first call should use -1 to start a new
group. Subsequent calls may create new groups or use the
returned file descriptor from <b>paf_ebb_pmu_init</b> to
associate events in a group. The file descriptor returned
should be closed when done to prevent resource leak.</p>

<p style="margin-left:11%; margin-top: 1em">The
<i>event-based exception</i> is triggered when the PMU
counter overflows. To set the PMC to an initial value
different from default (0) use <b>paf_ebb_pmu_set_period</b>
To reset it to potentially trigger another event call
<b>paf_ebb_pmu_reset().</b></p>


<p style="margin-left:11%; margin-top: 1em"><b>paf_ebb_register_handler()</b>
registers the user <i>handler</i> (<b>ebbhandler_t</b>)
function to be called when the EBB is triggered with the
argument <i>context.</i> Common state registers (LR, CR,
CTR, XER) are always saved and <i>type</i> specifies which
further set of registers will be saved and restored:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="2%"></td>
<td width="86%">


<p><b>PPCEBB_CALLBACK_GPR_SAVE:</b> save/restore all
General Purpose Registers.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="2%"></td>
<td width="86%">


<p><b>PPCEBB_CALLBACK_FPR_SAVE:</b> save/restore all
General Purpose Registers and all Floating-Point
Register.</p> </td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="2%"></td>
<td width="86%">


<p><b>PPCEBB_CALLBACK_VR_SAVE:</b> save/restore all General
Purpose Registers, all Floating-Point Register, and all
Vector Registers (VMX).</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>&bull;</p></td>
<td width="2%"></td>
<td width="86%">


<p><b>PPCEBB_CALLBACK_VSR_SAVE:</b> save/restore all
General Purpose Registers, all Floating-Point Register, all
Vector Registers (VMX), and all Vector Scalar Registers
(VSX).</p> </td></tr>
</table>

<p style="margin-left:11%; margin-top: 1em">The current
support <i>flags</i> is either 0 or a multibyte mask of bits
with one or more of the following options:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p style="margin-top: 1em">&bull;</p></td>
<td width="2%"></td>
<td width="86%">


<p style="margin-top: 1em"><b>PAF_EBB_FLAGS_RESET_PMU</b>
after the callback activation the EBB machanism will be
reset, similiar to a call to <b>paf_ebb_pmu_reset</b></p></td></tr>
</table>


<p style="margin-left:11%; margin-top: 1em"><b>paf_ebb_handler()</b>
returns the registered handler previously issued by
paf_ebb_register_handler().</p>


<p style="margin-left:11%; margin-top: 1em"><b>paf_ebb_enable_branches()</b>
enables EBB triggering.</p>


<p style="margin-left:11%; margin-top: 1em"><b>paf_ebb_disable_branches()</b>
disables EBB triggering.</p>

<h2>RETURN VALUE
<a name="RETURN VALUE"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>paf_ebb_pmu_init()</b>
returns a file descriptor to be used in group association or
-1 case of error.</p>


<p style="margin-left:11%; margin-top: 1em"><b>paf_ebb_register_handler()</b>
returns the registered handler or EBB_REG_ERR on error. On
error <i>errno</i> is set appropriately.</p>


<p style="margin-left:11%; margin-top: 1em"><b>paf_ebb_handler()</b>
returns the previous registered handler or EBB_REG_ERR if no
handler has been registered. On error <i>errno</i> is set
appropriately.</p>


<p style="margin-left:11%; margin-top: 1em"><b>paf_ebb_enable_branches()</b>
and <b>paf_ebb_disable_branches()</b> return 0 in case of
success or -1 otherwise. On error <i>errno</i> is set
appropriately.</p>

<h2>ERRORS
<a name="ERRORS"></a>
</h2>


<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="9%">


<p style="margin-top: 1em"><b>ENOSYS</b></p></td>
<td width="2%"></td>
<td width="56%">


<p style="margin-top: 1em">system does not support EBB
facility.</p> </td>
<td width="22%">
</td></tr>
</table>

<h2>VERSIONS
<a name="VERSIONS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The EBB
facility is part of Power ISA [category: Server] first
appearing in Power ISA 2.07.</p>

<p style="margin-left:11%; margin-top: 1em">Linux support
for the EBB facility first appeared in Linux kernel version
3.10.</p>

<p style="margin-left:11%; margin-top: 1em">Support for the
ELF EBB ABI first appeared in glibc version 2.18 though the
ABI is not runtime incompatible with backporting to earlier
glibc versions.</p>

<h2>EXAMPLE
<a name="EXAMPLE"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The following
example show how to setup a simple EBB handler to update a
global counter.</p>

<p style="margin-left:11%; margin-top: 1em">#include
&lt;stdio.h&gt; <br>
#include &lt;paf/ebb.h&gt; <br>
#include &lt;unistd.h&gt;</p>

<p style="margin-left:11%; margin-top: 1em">#define
PM_RUN_INST_CMPL 0x400FA</p>

<p style="margin-left:11%; margin-top: 1em">/* Set it
volatile to force memory read in loop below. */ <br>
static volatile int ebb_handler_triggered = 0;</p>

<p style="margin-left:11%; margin-top: 1em">static void
ebb_handler(void *context) <br>
{ <br>
int *trigger = (int*) (context); <br>
*trigger += 1; <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">void do_work
(void) <br>
{ <br>
while (1) <br>
{ <br>
if (ebb_handler_triggered == 1000) <br>
break; <br>
} <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">int
do_ebb(void) <br>
{ <br>
ebbhandler_t handler; <br>
ebb_handler_triggered = 0; <br>
int ebb_fd;</p>

<p style="margin-left:11%; margin-top: 1em">ebb_fd =
paf_ebb_pmu_init (PM_RUN_INST_CMPL, -1);</p>


<p style="margin-left:11%; margin-top: 1em">paf_ebb_pmu_set_period
(500000);</p>

<p style="margin-left:11%; margin-top: 1em">handler =
paf_ebb_register_handler (ebb_handler, <br>
(void*)&amp;ebb_handler_triggered, <br>
PAF_EBB_CALLBACK_GPR_SAVE, <br>
PAF_EBB_FLAGS_RESET_PMU);</p>


<p style="margin-left:11%; margin-top: 1em">paf_ebb_pmu_reset
();</p>


<p style="margin-left:11%; margin-top: 1em">paf_ebb_enable_branches
();</p>

<p style="margin-left:11%; margin-top: 1em">do_work ();</p>


<p style="margin-left:11%; margin-top: 1em">paf_ebb_disable_branches
();</p>

<p style="margin-left:11%; margin-top: 1em">printf
(&quot;Done; %d EBB interrupts handled\n&quot;,
ebb_handler_triggered);</p>

<p style="margin-left:11%; margin-top: 1em">close
(ebb_fd);</p>

<p style="margin-left:11%; margin-top: 1em">return 0; <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">int main (int
argc, char *argv[]) <br>
{ <br>
return do_ebb (); <br>
}</p>

<h2>SEE ALSO
<a name="SEE ALSO"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>libpaf-dsc</b>(3)</p>

<h2>REFERENCES
<a name="REFERENCES"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>Power
ISA&trade; Version 2.07</b></p>

<h2>REPORTING BUGS
<a name="REPORTING BUGS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Email bug
reports to Adhemerval Zanella
&lt;azanella@linux.vnet.ibm.com&gt;.</p>

<h2>AUTHORS
<a name="AUTHORS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">This manual
page was written by Adhemerval Zanella
&lt;azanella@linux.vnet.ibm.com&gt; and Ryan S. Arnold.</p>
<hr>
</body>
</html>
