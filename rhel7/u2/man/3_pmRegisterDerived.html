<!-- Creator     : groff version 1.22.2 -->
<!-- CreationDate: Fri Nov 11 02:09:04 2016 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>PMREGISTERDERIVED</title>

</head>
<body>

<h1 align="center">PMREGISTERDERIVED</h1>

<a href="#NAME">NAME</a><br>
<a href="#C SYNOPSIS">C SYNOPSIS</a><br>
<a href="#DESCRIPTION">DESCRIPTION</a><br>
<a href="#SEMANTIC CHECKS AND RULES">SEMANTIC CHECKS AND RULES</a><br>
<a href="#EXPRESSION EVALUATION">EXPRESSION EVALUATION</a><br>
<a href="#CAVEATS">CAVEATS</a><br>
<a href="#DIAGNOSTICS">DIAGNOSTICS</a><br>
<a href="#SEE ALSO">SEE ALSO</a><br>

<hr>


<h2>NAME
<a name="NAME"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>pmRegisterDerived</b>
&minus; register a derived metric name and definition</p>

<h2>C SYNOPSIS
<a name="C SYNOPSIS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>#include
&lt;pcp/pmapi.h&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>char
*pmRegisterDerived(char *</b><i>name</i><b>, char
*</b><i>expr</i><b>);</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>cc ...
&minus;lpcp</b></p>

<h2>DESCRIPTION
<a name="DESCRIPTION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Derived metrics
provide a way of extending the Performance Metrics Name
Space (PMNS) with new metrics defined at the PCP client-side
using arithmetic expressions over the existing performance
metrics.</p>

<p style="margin-left:11%; margin-top: 1em">Typical uses
would be to aggregate a number of similar metrics to provide
a higher-level summary metric or to support the
&lsquo;&lsquo;delta V over delta V&rsquo;&rsquo; class of
metrics that are not possible in the base data semantics of
PCP. An example of the latter class would be the average I/O
size, defined as</p>

<p align="center"><tt>delta(disk.dev.total_bytes) /
delta(disk.dev.total)</tt> where both of the
<tt>disk.dev</tt> metrics are counters, and what is required
is to to sample both metrics, compute the difference between
the current and previous values and then calculate the ratio
of these differences.</p>

<p style="margin-top: 1em">The arguments to
<b>pmRegisterDerived</b> are the <i>name</i> of the new
derived metric and <i>expr</i> is an arithmetic expression
defining how the values of <i>name</i> should be
computed.</p>

<p style="margin-top: 1em"><i>name</i> should follow the
syntactic rules for the names of performance metrics, namely
one or more components separated with a dot
(&lsquo;&lsquo;.&rsquo;&rsquo;), and each component must
begin with an alphabetic followed by zero or more characters
drawn from the alphabetics, numerics and underscore
(&lsquo;&lsquo;_&rsquo;&rsquo;). For more details, refer to
<b>PCPIntro</b>(1) and <b>pmns</b>(5).</p>

<p style="margin-top: 1em"><i>name</i> must be unique
across all derived metrics and should <b>not</b> match the
name of any regular metric in the PMNS. It is acceptable for
<i>name</i> to share some part of its prefix with an
existing subtree of the PMNS, e.g. the average I/O size
metric above could be named <tt>disk.dev.avgsz</tt> which
would place it amongst the other <tt>disk.dev</tt> metrics
in the PMNS. Alternatively, derived metrics could populate
their own subtree of the PMNS, e.g. the average I/O size
metric above could be named
<tt>my.summary.disk.avgsz</tt>.</p>

<p style="margin-top: 1em">The expression <i>expr</i>
follows these syntactic rules:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>*</p></td>
<td width="2%"></td>
<td width="86%">


<p>Terminal elements are either names of existing metrics
or integer constants. Recursive definitions are not allowed,
so only the names of regular metrics (not other derived
metrics) may be used. Integer constants are constrained to
the precision of 32-bit unsigned integers.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>*</p></td>
<td width="2%"></td>
<td width="86%">


<p>The usual binary arithmetic operators are supported,
namely &minus; addition (&lsquo;&lsquo;+&rsquo;&rsquo;),
subtraction (&lsquo;&lsquo;-&rsquo;&rsquo;), multiplication
(&lsquo;&lsquo;*&rsquo;&rsquo;) and division
(&lsquo;&lsquo;/&rsquo;&rsquo;) with the normal precedence
rules where multiplication and division have higher
precedence than addition and subtraction, so <tt>a+b*c</tt>
is evaluated as <tt>a+(b*c)</tt></p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>*</p></td>
<td width="2%"></td>
<td width="86%">


<p>Parenthesis may be used for grouping.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>*</p></td>
<td width="2%"></td>
<td width="86%">


<p>The following unary functions operate on a single
performance metric and return one or more values. For all
functions (except <tt>count()</tt> and <tt>instant()</tt>),
the type of the operand metric must be arithmetic (integer
of various sizes and signedness, float or double).</p></td></tr>
</table>


<p align="center" style="margin-top: 1em"><img src="grohtml-193541.png" alt="Image grohtml-193541.png"></p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p style="margin-top: 1em">*</p></td>
<td width="2%"></td>
<td width="35%">


<p style="margin-top: 1em">White space is ignored.</p></td>
<td width="51%">
</td></tr>
</table>

<p style="margin-left:11%; margin-top: 1em">Syntactic
checking is performed at the time <b>pmRegisterDerived</b>
is called, but semantic checking is deferred until each new
context is created with <b>pmNewContext</b>(3) or
re-established with <b>pmReconnectContext</b>(3), at which
time the PMNS and metadata is available to allow semantic
checking and the metadata of the derived metrics to be
established.</p>

<h2>SEMANTIC CHECKS AND RULES
<a name="SEMANTIC CHECKS AND RULES"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">There are a
number of conversions required to determine the metadata for
a derived metric and to ensure the semantics of the
expressions are sound.</p>

<p style="margin-left:11%; margin-top: 1em">In a binary
expression, if the semantics of both operands is not a
counter (i.e. PM_SEM_INSTANT or PM_SEM_DISCRETE) then the
result will have semantics PM_SEM_INSTANT unless both
operands are PM_SEM_DISCRETE in which case the result is
also PM_SEM_DISCRETE.</p>

<p style="margin-left:11%; margin-top: 1em">The mapping of
the pmUnits of the metadata uses the following rules:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p style="margin-top: 1em">*</p></td>
<td width="2%"></td>
<td width="86%">


<p style="margin-top: 1em">If both operands have a
dimension of COUNT and the scales are not the same, use the
larger scale and convert the values of the operand with the
smaller scale.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>*</p></td>
<td width="2%"></td>
<td width="86%">


<p>If both operands have a dimension of TIME and the scales
are not the same, use the larger scale and convert the
values of the operand with the smaller scale.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>*</p></td>
<td width="2%"></td>
<td width="86%">


<p>If both operands have a dimension of SPACE and the
scales are not the same, use the larger scale and convert
the values of the operand with the smaller scale.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>*</p></td>
<td width="2%"></td>
<td width="86%">


<p>For addition and subtraction all dimensions for each of
the operands and result are identical.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>*</p></td>
<td width="2%"></td>
<td width="86%">


<p>For multiplication, the dimensions of the result are the
sum of the dimensions of the operands.</p></td></tr>
<tr valign="top" align="left">
<td width="11%"></td>
<td width="1%">


<p>*</p></td>
<td width="2%"></td>
<td width="86%">


<p>For division, the dimensions of the result are the
difference of the dimensions of the operands.</p></td></tr>
</table>

<p style="margin-left:11%; margin-top: 1em">Scale
conversion involves division if the dimension is positive
else multiplication if the dimension is negative. If scale
conversion is applied to either of the operands, the result
is promoted to type PM_TYPE_DOUBLE.</p>

<p style="margin-left:11%; margin-top: 1em">Putting all of
this together in an example, consider the derived metric
defined as follows:</p>

<p align="center"><tt>x = network.interface.speed -
delta(network.interface.in.bytes) /
delta(sample.milliseconds)</tt></p>

<p>The type, dimension and scale settings would propagate
up the expression tree as follows.</p>


<p align="center" style="margin-top: 1em"><img src="grohtml-193542.png" alt="Image grohtml-193542.png"></p>

<p style="margin-left:11%;">Because semantic checking
cannot be done at the time <b>pmRegisterDerived</b> is
called, errors found during semantic checking are reported
using <b>pmprintf</b>(3). These include: <br>
Error: derived metric &lt;name1&gt;: operand: &lt;name2&gt;:
&lt;reason&gt;</p>

<p style="margin-left:22%;">There was a problem calling
<b>pmLookupName</b>(3) to identify the operand metric
&lt;name2&gt; used in the definition of the derived metric
&lt;name1&gt;.</p>

<p style="margin-left:11%;">Error: derived metric
&lt;name1&gt;: operand (&lt;name2&gt; [&lt;pmid2&gt;]):
&lt;reason&gt;</p>

<p style="margin-left:22%;">There was a problem calling
<b>pmLookupDesc</b>(3) to identify the operand metric
&lt;name2&gt; with PMID &lt;pmid2&gt; used in the definition
of the derived metric &lt;name1&gt;.</p>

<p style="margin-left:11%;">Semantic error: derived metric
&lt;name&gt;: &lt;operand&gt; &lt;op&gt; &lt;operand&gt;:
<br>
Illegal operator for counters</p>

<p style="margin-left:22%;">If both operands have the
semantics of counter, only addition or subtraction make
sense, so multiplication and division are not allowed.</p>

<p style="margin-left:11%;">Semantic error: derived metric
&lt;name&gt;: &lt;operand&gt; &lt;op&gt; &lt;operand&gt;:
<br>
Illegal operator for counter and non-counter</p>

<p style="margin-left:22%;">Only multiplication or division
are allowed if the left operand has the semantics of a
counter and the right operand is <b>not</b> a counter.</p>

<p style="margin-left:11%;">Semantic error: derived metric
&lt;name&gt;: &lt;operand&gt; &lt;op&gt; &lt;operand&gt;:
<br>
Illegal operator for non-counter and counter</p>

<p style="margin-left:22%;">Only multiplication is allowed
if the right operand has the semantics of a counter and the
left operand is <b>not</b> a counter.</p>

<p style="margin-left:11%;">Semantic error: derived metric
&lt;name&gt;: &lt;operand&gt; &lt;op&gt; &lt;operand&gt;:
<br>
Non-arithmetic type for &lt;left-or-right&gt; operand</p>

<p style="margin-left:22%;">The binary arithmetic operators
are only allowed with operands with an arithmetic type
(integer of various sizes and signedness, float or
double).</p>

<p style="margin-left:11%;">Semantic error: derived metric
&lt;name&gt;: &lt;function&gt;(&lt;operand&gt;): <br>
Non-arithmetic operand for function</p>

<p style="margin-left:22%;">The unary functions are only
defined if the operand has arithmetic type.</p>

<p style="margin-left:11%;">Semantic error: derived metric
&lt;name&gt;: Incorrect time dimension for <br>
operand</p>

<p style="margin-left:22%;">Rate conversion using the
<b>rate</b>() function is only possible for operand metrics
with a Time dimension of 0 or 1 (see
<b>pmLookupDesc</b>(3)). If the operand metric&rsquo;s Time
dimension is 0, then the derived metrics has a value
&quot;per second&quot; (Time dimension of &minus;1). If the
operand metric&rsquo;s Time dimension is 1, then the derived
metrics has a value of time utilization (Time dimension of
0).</p>

<h2>EXPRESSION EVALUATION
<a name="EXPRESSION EVALUATION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">For the binary
arithmetic operators, if either operand must be scaled (e.g.
convert bytes to Kbytes) then the result is promoted to
PM_TYPE_DOUBLE. Otherwise the type of the result is
determined by the types of the operands, as per the
following table which is evaluated from top to bottom until
a match is found.</p>


<p align="center" style="margin-top: 1em"><img src="grohtml-193543.png" alt="Image grohtml-193543.png"></p>

<h2>CAVEATS
<a name="CAVEATS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Unary negation
is not supported, so the following expressions would be
syntactically incorrect, <tt>&minus;3*abc</tt> and
<tt>&minus;this.number</tt></p>

<p style="margin-left:11%; margin-top: 1em">Derived metrics
are not available when using <b>pmFetchArchive</b>(3) as
this routine does not use a target list of PMIDs that could
be remapped (as is done for <b>pmFetch</b>(3)).</p>


<p style="margin-left:11%; margin-top: 1em"><b>pmRegisterDerived</b>
does not apply retrospectively to any open contexts, so the
normal use would be to make all calls to
<b>pmRegisterDerived</b> (possibly via
<b>pmLoadDerivedConfig</b>(3)) and then call
<b>pmNewContext</b>(3).</p>

<p style="margin-left:11%; margin-top: 1em">There is no
<b>pmUnregisterDerived</b> method, so once registered a
derived metric persists for the life of the application.</p>

<h2>DIAGNOSTICS
<a name="DIAGNOSTICS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">On success,
<b>pmRegisterDerived</b> returns NULL.</p>

<p style="margin-left:11%; margin-top: 1em">If a syntactic
error is found at the time of registration, the value
returned by <b>pmRegisterDerived</b> is a pointer into
<i>expr</i> indicating <b>where</b> the error was found. To
identify <b>what</b> the error was, the application should
call <b>pmDerivedErrStr</b>(3) to retrieve the corresponding
parser error message.</p>

<h2>SEE ALSO
<a name="SEE ALSO"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>PCPIntro</b>(1),
<b>PMAPI</b>(3), <b>pmDerivedErrStr</b>(3),
<b>pmFetch</b>(3), <b>pmLoadDerivedConfig</b>(3),
<b>pmNewContext</b>(3) and <b>pmReconnectContext</b>(3).</p>
<hr>
</body>
</html>
